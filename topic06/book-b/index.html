 <!DOCTYPE html>
 <html>
   <head>
     <meta charset="utf-8" />
     <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
   
     <title> MyRent-07 </title>
   
     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

     <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.2.0/semantic.min.css" type='text/css'>
     <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
     <script src="http://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.2.0/semantic.min.js"></script>

     <link  href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/solarized_light.min.css" rel="stylesheet" />
     <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/highlight.min.js"></script>
     <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/languages/java.min.js"></script>
     <script>hljs.initHighlightingOnLoad();</script>

    <style>


body 
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
}

#container
{
  margin :10px
}

code
{
	font-family: "Monaco";
	font-size: 110%;
}

h1 
{
  font-style:italic;
  font-size:120%;
  border-bottom: thin solid black;
}
h2 
{
  font-size:110%;
  border-bottom: thin solid black;
}
h3 
{
  font-size:100%;
  border-bottom: thin solid black;
}

#footertext 
{
  font-size:70%
}

#title 
{
  font-size:120%;
  color: black;
  text-align: right;
  background-color : white;
}

img 
{
   padding:1px;
   border:1px solid black;
   margin-top: 10px;
   margin-bottom: 10px;
}

header img
{
	 padding:1px;
   border:0px solid black;
}

header h1
{
  font-style:normal;
  font-size:120%;
  border-bottom: 0px;
}

header h2
{
  font-style:normal;
  font-size:100%;
  border-bottom: 0px;
}

header h3
{
  font-style:normal;
  font-size:90%;
  border-bottom: 0px;
}

.cover
{
    width: 290px;
    height: 290px;
    border:1px solid lightgray;
}
.image-thumbnail
{
    height: 100%;
    background-size: cover;
    -moz-background-size: cover;
    -webkit-background-size: cover;
    background-position: center;
}

#container .card .description {
  min-height: 200px;
}

    </style>

  </head>
  <body>
  <nav class="ui fixed top pointing borderless inverted menu">
    <header class="header item"> <a href="../index.html">6: Streams & File IO</a></header>
    <div class="right tab-menu menu">
          <a class="item" data-tab="MyRent-07"> MyRent-07 </a>
          <a class="item" data-tab="01"> 01 </a>
          <a class="item" data-tab="02"> 02 </a>
          <a class="item" data-tab="03"> 03 </a>
          <a class="item" data-tab="04"> 04 </a>
          <a class="item" data-tab="05"> 05 </a>
          <a class="item" data-tab="06"> 06 </a>
          <a class="item" data-tab="07"> 07 </a>
          <a class="item" data-tab="Archives"> Archives </a>
    </div>
  </nav>

  <br>

	  <section data-tab="MyRent-07" class="ui tab stacked moodle-book segment">
	     <h1>Residence List Deletion &amp; ViewPager</h1>
<p>In this lab we introduce a facility to select and delete a subset of residences in the list view. The selected items need not be contiguous. Also, introduce a new feature to support 'swipe' interaction. This allows a user to swipe left/right to page through the residence list.</p>
	  </section>
	  <section data-tab="01" class="ui tab stacked moodle-book segment">
	     <h1>Preview</h1>
<p><img alt="Figure 1: Long press to engage contextual menu to delete selection from list" src="img/02.png"></p>
<p><img alt="Figure 2: Use ViewPager to introduce swipe facility" src="img/19.png"></p>
	  </section>
	  <section data-tab="02" class="ui tab stacked moodle-book segment">
	     <h1>Resources (Contextual Menu)</h1>
<p>Add a new context menu resource.</p>
<p>Filename: res/menu/residence_list_context.xml</p>
<pre><code>&lt;menu
  xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;
    &lt;item android:id=&quot;@+id/menu_item_delete_residence&quot;
    android:icon=&quot;@android:drawable/ic_menu_delete&quot;
    android:title=&quot;@string/delete_residence&quot; /&gt;
&lt;/menu&gt;

</code></pre>

<p>We would like the selected residences to appear highlighted for ease of identification. Add the following xml file in a new folder <em>drawable</em>:</p>
<p>Filename: res/drawable/background_activated.xml</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;selector xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; &gt;
  &lt;item
    android:state_activated=&quot;true&quot;
    android:drawable=&quot;@android:color/darker_gray&quot;
    /&gt;
&lt;/selector&gt;

</code></pre>

<p>Activate the <em>background_activated</em> state by adding the following attribute to res/layout/list_item_residence.xml.</p>
<ul>
<li>Failure to introduce this line of code will result in selected residence in the list remaining highlighted only as long as the mouse button is pressed.</li>
</ul>
<pre><code>    android:background=&quot;@drawable/background_activated&quot;
</code></pre>

<p>Here is the complete file:</p>
<p>Filename: list_item_residence.xml</p>
<pre><code>&lt;RelativeLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    android:layout_width=&quot;match_parent&quot;
    android:layout_height=&quot;match_parent&quot;
    android:background=&quot;@drawable/background_activated&quot;
    android:orientation=&quot;vertical&quot;&gt;

    &lt;CheckBox
        android:id=&quot;@+id/residence_list_item_isrented&quot;
        android:layout_width=&quot;wrap_content&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:gravity=&quot;center&quot;
        android:layout_alignParentRight=&quot;true&quot;
        android:enabled=&quot;false&quot;
        android:focusable=&quot;false&quot;
        android:padding=&quot;4dp&quot;
         /&gt;

    &lt;TextView
        android:id=&quot;@+id/residence_list_item_geolocation&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:layout_toLeftOf=&quot;@id/residence_list_item_isrented&quot;
        android:textStyle=&quot;bold&quot;
        android:paddingLeft=&quot;4dp&quot;
        android:paddingRight=&quot;4dp&quot;
        /&gt;

    &lt;TextView
        android:id=&quot;@+id/residence_list_item_dateTextView&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:layout_below=&quot;@id/residence_list_item_geolocation&quot;
        android:layout_toLeftOf=&quot;@id/residence_list_item_isrented&quot;
        android:paddingLeft=&quot;4dp&quot;
        android:paddingRight=&quot;4dp&quot;
        android:paddingTop=&quot;4dp&quot;/&gt;

&lt;/RelativeLayout&gt;
</code></pre>

<p>Add string resource:</p>
<pre><code>&lt;string name=&quot;delete_residence&quot;&gt;Delete Residence&lt;/string&gt;  
</code></pre>

<p><img alt="Press and hold trash can to display menu label" src="img/03.png"></p>
	  </section>
	  <section data-tab="03" class="ui tab stacked moodle-book segment">
	     <h1>ResidenceListFragment</h1>
<p>Add imports:</p>
<pre><code>import android.view.ActionMode;
import android.widget.AbsListView.MultiChoiceModeListener;
</code></pre>

<p>Change class signature by implementing MultiChoiceModeListener:</p>
<pre><code>public class ResidenceListFragment extends ListFragment implements OnItemClickListener, MultiChoiceModeListener
</code></pre>

<p>Add a ListView field:</p>
<pre><code>private ListView listView;
</code></pre>

<p>In onCreateView initialize the listView and set listener:</p>
<pre><code>    listView = (ListView) v.findViewById(android.R.id.list);
    listView.setChoiceMode(ListView.CHOICE_MODE_MULTIPLE_MODAL);
    listView.setMultiChoiceModeListener(this);
</code></pre>

<p>Implement MultiChoiceModeListener methods:</p>
<pre><code>  /* ************ MultiChoiceModeListener methods (begin) *********** */
  @Override
  public boolean onCreateActionMode(ActionMode mode, Menu menu)
  {
    MenuInflater inflater = mode.getMenuInflater();
    inflater.inflate(R.menu.residence_list_context, menu);
    return true;
  }

  @Override
  public boolean onPrepareActionMode(ActionMode mode, Menu menu)
  {
    return false;
  }

  @Override
  public boolean onActionItemClicked(ActionMode mode, MenuItem item)
  {
    switch (item.getItemId())
    {
    case R.id.menu_item_delete_residence:
      deleteResidence(mode);
      return true;
    default:
      return false;
    }

  }

  private void deleteResidence(ActionMode mode)
  {
    for (int i = adapter.getCount() - 1; i &gt;= 0; i--)
    {
      if (listView.isItemChecked(i))
      {
        portfolio.deleteResidence(adapter.getItem(i));
      }
    }
    mode.finish();
    adapter.notifyDataSetChanged();
  }

  @Override
  public void onDestroyActionMode(ActionMode mode)
  {
  }

  @Override
  public void onItemCheckedStateChanged(ActionMode mode, int position, long id, boolean checked)
  {
  }

  /* ************ MultiChoiceModeListener methods (end) *********** */

</code></pre>

<h1>Model Layer</h1>
<p>Add a method to Portfolio to delete a residence :</p>
<pre><code>  public void deleteResidence(Residence c)
  {
    residences.remove(c);
  }
</code></pre>
	  </section>
	  <section data-tab="04" class="ui tab stacked moodle-book segment">
	     <h1>ViewPager</h1>
<p>Here we shall refactor MyRent by incorporating a ViewPager.</p>
<ul>
<li>This will allow us to swipe between pages as illustrated in Figure 1.</li>
</ul>
<p><img alt="Figure 1: Swipe between pages" src="img/19.png"></p>
<p>The refactoring is shown in Figure 2 where the changes are highlighted: compare this object diagram to that in the previous step and you will see that the main change is the replacement of ResidenceActivity with a new class ResidencePagerActivity. </p>
<p><img alt="Figure 2: Object diagram following introduction of ViewPager" src="img/20.png"></p>
	  </section>
	  <section data-tab="05" class="ui tab stacked moodle-book segment">
	     <h1>Resources (ViewPager)</h1>
<p>Create a new file <em>ids.xml</em> in res/values folder which will be used to store viewPager id numbers:</p>
<p>Filename: ids.xml</p>
<pre><code>&lt;resources&gt;
    &lt;item type=&quot;id&quot; name=&quot;viewPager&quot; /&gt;
&lt;/resources&gt;

</code></pre>

<p>Change the ResidenceActivity node in the manifest file to ResidencePagerActivity.</p>
<p><img alt="" src="img/01.png"></p>
<pre><code>    &lt;activity 
        android:name=&quot;.activities.ResidencePagerActivity&quot;
        android:label=&quot;@string/app_name&quot;&gt;

        &lt;meta-data  
          android:name=&quot;android.support.PARENT_ACTIVITY&quot;
          android:value=&quot;.activities.ResidenceListActivity&quot;/&gt;
    &lt;/activity&gt;
</code></pre>
	  </section>
	  <section data-tab="06" class="ui tab stacked moodle-book segment">
	     <h1>Create ResidencePagerActivity</h1>
<p>Note: not all import statements are included: </p>
<ul>
<li>
<p>You may use QuickFix to identify missing entities. </p>
</li>
<li>
<p>Alternatively, on the Mac, the key combination <em>Shift + cmd + O</em> (upper case letter oh), automatically inserts missing imports.</p>
</li>
<li>Further information on shortcut keys is available <a href="http://tkramar.blogspot.ie/2007/10/effective-eclipse-ii-shortcut-keys_16.html">here</a></li>
</ul>
<p>Delete ResidenceActivity and replace with ResidencePagerActivity, the code for which follows:</p>
<p>Filename: ResidencePagerActivity.java</p>
<pre><code>package org.wit.myrent.activities;

import android.os.Bundle;
import android.support.v4.app.FragmentActivity;
import android.support.v4.view.ViewPager;


public class ResidencePagerActivity extends FragmentActivity
{
  private ViewPager viewPager;


  @Override
  public void onCreate(Bundle savedInstanceState) 
  {
    super.onCreate(savedInstanceState);
  }
}
</code></pre>

<p>This file is necessary because ViewPager requires a resource id.</p>
<ul>
<li>ViewPager is a fragment container and so requires a resource id.</li>
</ul>
<p>Create and show ViewPager:</p>
<ul>
<li>Add this code to ResidencePagerActivity.onCreate following the call to <em>super.onCreate</em>.<ul>
<li>This creates a view programatically.</li>
</ul>
</li>
</ul>
<pre><code>    viewPager = new ViewPager(this);
    viewPager.setId(R.id.viewPager);
    setContentView(viewPager);
</code></pre>

<p>Import:</p>
<pre><code>import org.wit.myrent.R;
</code></pre>

<p>Next we introduce code to facilitate retrieval of views that are required as a user swipes left or right.</p>
<p>Introduce instance variables for a list of residences and portfolio:</p>
<pre><code>  private ArrayList&lt;Residence&gt; residences;  
  private Portfolio portfolio;
</code></pre>

<p>Add this private method to obtain a reference to the list of references stored in the model layer:</p>
<pre><code>  private void setResidenceList()
  {
    MyRentApp app = (MyRentApp) getApplication();
    portfolio = app.portfolio; 
    residences = portfolio.residences;    
  }
</code></pre>

<p>Invoke <em>setResidenceList</em> immediately following <em>setContentView</em> in <em>onCreate</em>.</p>
<p>Add this private class at the end of ResidencePagerActivity.</p>
<pre><code>  class PagerAdapter extends FragmentStatePagerAdapter 
  {
    private ArrayList&lt;Residence&gt;  residences; 

    public PagerAdapter(FragmentManager fm, ArrayList&lt;Residence&gt; residences)
    {
      super(fm);
      this.residences = residences;
    }

    @Override
    public int getCount()  
    {  
      return residences.size();  
    }

    @Override
    public Fragment getItem(int pos) 
    {
      Residence residence = residences.get(pos);
      Bundle args = new Bundle();
      args.putSerializable(ResidenceFragment.EXTRA_RESIDENCE_ID, residence.id);
      ResidenceFragment fragment = new ResidenceFragment();
      fragment.setArguments(args);
      return fragment;
    } 
  }
</code></pre>

<p>Ensure this new class is contained within ResidencePagerActivity as shown here:</p>
<p><img alt="" src="img/25.png"></p>
<p>Change the signature of ResidencePagerActivity to the following:</p>
<pre><code>public class ResidencePagerActivity extends FragmentActivity implements ViewPager.OnPageChangeListener

</code></pre>

<p>Official documentation on ViewPager.OnPageChangeListener is available <a href="http://developer.android.com/reference/android/support/v4/view/ViewPager.OnPageChangeListener.html">here</a>.</p>
<p>This change will trigger errors that may be eliminated by using QuickFix to implement the required interface methods:</p>
<pre><code>
  @Override
  public void onPageScrollStateChanged(int arg0)
  {
  }

  @Override
  public void onPageScrolled(int arg0, float arg1, int arg2)
  {
  }

  @Override
  public void onPageSelected(int arg0)
  {
  }
</code></pre>

<p>We are only interested in full implementation of <em>onPageScrolled</em>. Here it is:</p>
<pre><code>
  @Override
  public void onPageScrolled(int arg0, float arg1, int arg2)
  {
    info(this, &quot;onPageScrolled: arg0 &quot;+arg0+&quot; arg1 &quot;+arg1+&quot; arg2 &quot;+arg2);
    Residence residence = residences.get(arg0);
    if (residence.geolocation != null)
    {
      setTitle(residence.geolocation);
    }
  }
</code></pre>

<p>The method <em>info</em> is implemented in the helpers folder and may be imported in a similar manner as previously in, for example, ResidenceFragment.</p>
<p>This last feature is illustrated in Figure 1 below.</p>
<p><img alt="Figure 1: Changing Action Bar Title" src="img/21.png"></p>
<p>Next add a PageAdapter instance variable:</p>
<pre><code>  private PagerAdapter          pagerAdapter;
</code></pre>

<ul>
<li>Instantiate pagerAdapter in <em>onCreate</em></li>
<li>Pass the new object as an argument to ViewPager.setAdapter.</li>
<li>Register the OnPageListener</li>
<li>The following 3 lines of code should be located following the invocation of <em>setResidenceList</em></li>
</ul>
<pre><code>    pagerAdapter = new PagerAdapter(getSupportFragmentManager(), residences);
    viewPager.setAdapter(pagerAdapter);
    viewPager.setOnPageChangeListener(this);

</code></pre>
	  </section>
	  <section data-tab="07" class="ui tab stacked moodle-book segment">
	     <h1>Integrate ResidencePagerActivity</h1>
<p>To date in ResidenceListActivity.onListItemClick:</p>
<ul>
<li>When a list item is clicked the ResidenceActivity is started.</li>
</ul>
<p>We now wish to start ResidencePagerActivity:</p>
<ul>
<li>To do so, in ResidenceListFragment, replace the following code:</li>
</ul>
<p><img alt="" src="img/24.png"></p>
<p>with this:</p>
<pre><code>Intent i = new Intent(getActivity(), ResidencePagerActivity.class);
</code></pre>

<p>In ResidenceListFragment, replace any other references to ResidenceActivity with ResidencePagerActivity.</p>
<p>Run MyRent and click on any element in the list: this should open the associated details view.</p>
<ul>
<li>You should be able to swipe left and right.</li>
<li>Should you have difficulty doing so on an emulator, try it on a physical device.</li>
</ul>
<p>Observe, however, that irrespective which residence on the list is pressed, the first on the list is displayed in the details view. This will now be fixed by implementing a method <em>setCurrentItem</em> in ResidencePagerActivity:</p>
<pre><code>  /*
   * Ensure selected residence is shown in details view
   */
  private void setCurrentItem()
  {
    UUID res = (UUID) getIntent().getSerializableExtra(ResidenceFragment.EXTRA_RESIDENCE_ID);
    for (int i = 0; i &lt; residences.size(); i++)
    {
      if (residences.get(i).id.toString().equals(res.toString()))
      {
        viewPager.setCurrentItem(i);
        break;
      }
    }
  }
</code></pre>

<p>An import statement is necessary for the UUID:</p>
<pre><code>import java.util.UUID;
</code></pre>

<p>Invoke <em>setCurrentItem</em> at the end of <em>ResidencePagerActivity.onCreate</em>.</p>
<p>Here is a brief description of <em>setCurrentItem</em>:</p>
<ul>
<li>We simply obtain the id of the residence displayed in the details view from the activity intent, </li>
<li>then iterate through the list of residences to find a match</li>
<li>and having found a matching residence, invoke <em>setCurrent</em> item using the index position of the residence object as an argument.</li>
</ul>
<p>Here is the final <em>onCreate</em>:</p>
<pre><code>  @Override
  public void onCreate(Bundle savedInstanceState) 
  {
    super.onCreate(savedInstanceState);
    viewPager = new ViewPager(this);
    viewPager.setId(R.id.viewPager);
    setContentView(viewPager);
    setResidenceList();
    pagerAdapter = new PagerAdapter(getSupportFragmentManager(), residences);
    viewPager.setAdapter(pagerAdapter); 
    viewPager.setOnPageChangeListener(this);
    setCurrentItem();
  }
</code></pre>

<p>For reference, the complete list of imports is provided below:</p>
<pre><code>import java.util.ArrayList;
import java.util.UUID;

import org.wit.myrent.R;
import org.wit.myrent.app.MyRentApp;
import org.wit.myrent.models.Portfolio;
import org.wit.myrent.models.Residence;

import android.os.Bundle;
import android.support.v4.app.Fragment;
import android.support.v4.app.FragmentActivity;
import android.support.v4.app.FragmentManager;
import android.support.v4.app.FragmentStatePagerAdapter;
import android.support.v4.view.ViewPager;
import static org.wit.android.helpers.LogHelpers.info;
</code></pre>

<p><strong>ResidenceFragment</strong></p>
<p>One final item needs attention. Replace this line in ResidenceFragment:</p>
<p><img alt="" src="img/04.png"></p>
<p>with this:</p>
<pre><code>UUID resId = (UUID)getArguments().getSerializable(EXTRA_RESIDENCE_ID);
</code></pre>

<p>This last line of code extracts the current residence id from the Bundle object that was created in the <em>PagerAdapter.getItem</em> method which is located in the file ResidencePagerActivity. </p>
<ul>
<li>There we added a fragment argument to the Bundle object. The value of this argument is the current residence id.</li>
<li>See here for a brief summary of fragment arguments taken from the Android Book by Hardy &amp; Philips:
<img alt="" src="img/05.png"></li>
</ul>
<p>Build and lauch the app on an emulator or device and check the functionality we have introduced in this lab.</p>
	  </section>
	  <section data-tab="Archives" class="ui tab stacked moodle-book segment">
	     <h1>Archives</h1>
<p>This is a version of MyRent complete to the end if this lab:</p>
<ul>
<li><a href="archives/MyRentV07.zip">MyRentV07</a></li>
</ul>
	  </section>
<script>

function addCaptions() {
  var images = $(".moodle-book img");
  jQuery.each(images, function(i)  {
    if((images[i].alt).length > 0) 
    {
      var div_img = $(document.createElement("div")).addClass("ui segment");
      $(images[i]).wrap(div_img);
      var div_label = $(document.createElement("div")).addClass("ui ribbon teal top attached label");
      div_label.append(images[i].alt);
      $(div_label).insertBefore(images[i]);
    }
  });
};

// Need to check if we have already been loaded
seen = 0;

$(document).ready(function()
{ 
  if (seen == 0)
  { 
    // not loaded before - so do the restyling once (need to moodle book print)
    $(".moodle-book img").addClass ("ui image");
    $(".moodle-book pre").addClass ("ui segment");
    addCaptions();
    seen = 1;
  }


})</script>
  <br>  
  <div class="ui fixed bottom borderless menu">'
    <div class="ui small item"> 
    <p id="footertext">
    Prepared by  Eamonn de Leastar (edeleastar@tssg.wit.ie) & John Fitzgerald (johnjfitzgerald@outlook.com). Except where otherwise noted, this content is licensed under a  
     <a  href="http://creativecommons.org/licenses/by-nc/4.0/" title="External link to http://creativecommons.org/licenses/by-nc/4.0/" 
       target="_blank">Creative Commons Attribution-NonCommercial 4.0 License
     </a>
     </p>
    </div>
  </div>   
    
  <script>
    $(document).ready(function()
    {  
      $('.tab-menu.menu .item').tab();
    });
  </script>   
  </body>
 </html>