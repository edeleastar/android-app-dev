 <!DOCTYPE html>
 <html>
   <head>
     <meta charset="utf-8" />
     <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
   
     <title> Donation-Service-01 </title>
   
     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

     <link rel="stylesheet" href="http://beta.semantic-ui.com/dist/semantic.min.css">
     <script src="http://beta.semantic-ui.com/javascript/library/jquery.min.js"></script>
     <script src="http://beta.semantic-ui.com/dist/semantic.min.js"></script>

     <link href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/solarized_light.min.css" rel="stylesheet" /> 
     <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/highlight.min.js"></script>
     <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/languages/java.min.js"></script>
     <script>hljs.initHighlightingOnLoad();</script>

    <style>


body 
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
}

#container
{
  margin :10px
}

code
{
	font-family: "Monaco";
	font-size: 110%;
}

h1 
{
  font-style:italic;
  font-size:120%;
  border-bottom: thin solid black;
}
h2 
{
  font-size:110%;
  border-bottom: thin solid black;
}
h3 
{
  font-size:100%;
  border-bottom: thin solid black;
}

#footertext 
{
  font-size:70%
}

#title 
{
  font-size:120%;
  color: black;
  text-align: right;
  background-color : white;
}

img 
{
   padding:1px;
   border:1px solid black;
   margin-top: 10px;
   margin-bottom: 10px;
}

header img
{
	 padding:1px;
   border:0px solid black;
}

header h1
{
  font-style:normal;
  font-size:120%;
  border-bottom: 0px;
}

header h2
{
  font-style:normal;
  font-size:100%;
  border-bottom: 0px;
}

header h3
{
  font-style:normal;
  font-size:90%;
  border-bottom: 0px;
}

.cover
{
    width: 290px;
    height: 290px;
    border:1px solid lightgray;
}
.image-thumbnail
{
    height: 100%;
    background-size: cover;
    -moz-background-size: cover;
    -webkit-background-size: cover;
    background-position: center;
}



    </style>

  </head>
  <body>
  <nav class="ui fixed top pointing borderless inverted menu">
    <header class="header item"> <a href="../index.html">9: APIs | Maps </a></header>
    <div class="right tab-menu menu">
          <a class="item" data-tab="Donation-Service-01"> Donation-Service-01 </a>
          <a class="item" data-tab="01"> 01 </a>
          <a class="item" data-tab="02"> 02 </a>
          <a class="item" data-tab="03"> 03 </a>
          <a class="item" data-tab="04"> 04 </a>
          <a class="item" data-tab="05"> 05 </a>
          <a class="item" data-tab="06"> 06 </a>
          <a class="item" data-tab="Exercises"> Exercises </a>
    </div>
  </nav>

  <br>

	  <section data-tab="Donation-Service-01" class="ui tab stacked moodle-book segment">
	     <h1>Objectives</h1>
<ul>
<li>Create a version of the the donation app as a play project</li>
<li>Expose an 'API' from this app to enable other programmes to use it</li>
<li>Rework the Donation android app to use this api</li>
</ul>
	  </section>
	  <section data-tab="01" class="ui tab stacked moodle-book segment">
	     <h1>Play Donation App</h1>
<p>Before starting this lab, it might be a good idea to download a fresh version of Eclipse - without any Android tools installed - and use this version just for the apps we are about to build in this lab. Select the 'Eclipse for Java EE Developers' distribution</p>
<p>Using Play, create  new app in the usual way:</p>
<pre><code>play new donation-service-play
</code></pre>

<p>Generate an eclipse view of the project"</p>
<pre><code>play eclipsify
</code></pre>

<p>Before you import this project into eclipse, create a new workspace - just for this project, ... and import the project in th usual way.</p>
<p>Create a new package called 'models' - and bring in these classes:</p>
<pre><code class="java">package models;

import javax.persistence.CascadeType;
import javax.persistence.Entity;
import javax.persistence.OneToMany;
import java.util.List;

import play.db.jpa.Model;

@Entity
public class Donation extends Model
{
  public int    amount;
  public String method;

  public Donation (int amount, String method)
  {
    this.amount = amount;
    this.method = method;
  }

  public String toString()
  {
    return amount + &quot;, &quot; + method;
  }
}
</code></pre>

<pre><code class="java">package models;

import javax.persistence.CascadeType;
import javax.persistence.Entity;
import javax.persistence.OneToMany;
import java.util.List;

import play.db.jpa.Model;

@Entity
public class User extends Model
{
  public String firstName;
  public String lastName;
  public String email;
  public String password;

  public User(String firstName, String lastName, String email, String password)
  {
    this.firstName = firstName;
    this.lastName = lastName;
    this.email = email;
    this.password = password;
  } 
}
</code></pre>
	  </section>
	  <section data-tab="02" class="ui tab stacked moodle-book segment">
	     <h1>Utils</h1>
<p>Create a new package called 'utils', and bring in these classes:</p>
<pre><code class="java">package utils;

import java.lang.annotation.Annotation;
import java.lang.reflect.Type;

import play.data.binding.Global;
import play.data.binding.TypeBinder;

import com.google.gson.JsonElement;
import com.google.gson.JsonParser;

@Global
public class GsonBinder implements TypeBinder&lt;JsonElement&gt;
{
  public Object bind(String name, Annotation[] notes, String value, Class toClass, Type toType) throws Exception
  {
    return new JsonParser().parse(value);
  }
}
</code></pre>

<pre><code class="java">package utils;

import java.lang.reflect.Type;
import java.util.List;
import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;
import models.Donation;
import models.User;

public class JsonParsers
{
  static Gson gson = new Gson();

  public static User json2User(String json)
  {
    return gson.fromJson(json, User.class);   
  }

  public static List&lt;User&gt; json2Users(String json)
  {
    Type collectionType = new TypeToken&lt;List&lt;User&gt;&gt;() {}.getType();
    return gson.fromJson(json, collectionType); 
  }

  public static String user2Json(Object obj)
  {
    return gson.toJson(obj);
  }  

  public static Donation json2Donation(String json)
  {
    return gson.fromJson(json, Donation.class);    
  }

  public static String donation2Json(Object obj)
  {
    return gson.toJson(obj);
  }  

  public static List&lt;Donation&gt; json2Donations(String json)
  {
    Type collectionType = new TypeToken&lt;List&lt;Donation&gt;&gt;() {}.getType();
    return gson.fromJson(json, collectionType);    
  }  
}
</code></pre>
	  </section>
	  <section data-tab="03" class="ui tab stacked moodle-book segment">
	     <h1>API</h1>
<p>Into the controllers package, create a new controller called 'DonationServiceAPI':</p>
<pre><code class="java">package controllers;

import play.*;
import play.mvc.*;
import utils.JsonParsers;

import java.util.*;

import com.google.gson.JsonElement;

import models.*;

public class DonationServiceAPI extends Controller
{
  public static void users()
  {
    List&lt;User&gt; users = User.findAll();
    renderJSON(JsonParsers.user2Json(users));
  }

  public static void user(Long id)
  {
    User user = User.findById(id);  
    if (user == null)
    {
      notFound();
    }
    else
    {
      renderJSON(JsonParsers.user2Json(user));
    }
  }

  public static void createUser(JsonElement body)
  {
    User user = JsonParsers.json2User(body.toString());
    user.save();
    renderJSON(JsonParsers.user2Json(user));
  }

  public static void deleteUser(Long id)
  {
    User user = User.findById(id);
    if (user == null)
    {
      notFound();
    }
    else
    {
      user.delete();
      renderText(&quot;success&quot;);
    }
  }

  public static void deleteAllUsers()
  {
    User.deleteAll();
    renderText(&quot;success&quot;);
  }    

  public static void donations()
  {
    List&lt;Donation&gt; donations = Donation.findAll();
    renderText(JsonParsers.donation2Json(donations));
  }

  public static void donation (Long id)
  {
   Donation donation = Donation.findById(id);
   renderJSON (JsonParsers.donation2Json(donation));
  }

  public static void createDonation(JsonElement body)
  {
    Donation donation = JsonParsers.json2Donation(body.toString());
    Donation newDonation = new Donation (donation.amount, donation.method);
    newDonation.save();
    renderJSON (JsonParsers.donation2Json(newDonation));
  }  


  public static void deleteDonation(Long id)
  {
    Donation donation = Donation.findById(id);
    if (donation == null)
    {
      notFound();
    }
    else
    {
      donation.delete();
      ok();
    }
  }  
}
</code></pre>
	  </section>
	  <section data-tab="04" class="ui tab stacked moodle-book segment">
	     <h1>Config</h1>
<p>Enable our in-memory database by uncommenting the usual setting in 'application.conf'</p>
<pre><code>db=mem
</code></pre>

<p>Introduce the 'Bootstrap' java class directly into the 'app' folder:</p>
<pre><code>import java.util.List;

import play.jobs.*;
import play.test.*;
import models.*;

@OnApplicationStart
public class Bootstrap extends Job 
{ 
  public void doJob()
  {
    if (User.count() == 0)
    {
     Fixtures.deleteDatabase(); 
     Fixtures.loadModels(&quot;data.yml&quot;);
    }
  }
}
</code></pre>

<p>.. and now specify our routes in config/routes:</p>
<pre><code>GET     /api/users                           DonationServiceAPI.users
GET     /api/users/{id}                      DonationServiceAPI.user
POST    /api/users                           DonationServiceAPI.createUser
DELETE  /api/users/{id}                      DonationServiceAPI.deleteUser

GET     /api/donations                       DonationServiceAPI.donations
GET     /api/donations/{id}                  DonationServiceAPI.donation
POST    /api/donations                       DonationServiceAPI.createDonation
DELETE  /api/donations/{id}                  DonationServiceAPI.deleteDonation
</code></pre>

<p>Finally, provide some initial database entries in conf/data.yml:</p>
<pre><code>User(homer):
    usaCitizen: true
    firstName: Homer
    lastName: Simpson
    email: homer@simpson.com
    password: secret

User(marge):
    usaCitizen: true
    firstName: Marge
    lastName: Simpson
    email: marge@simpson.com
    password: secret

User(lisa):
    usaCitizen: true
    firstName: Lisa
    lastName: Simpson
    email: lisa@simpson.com
    password: secret

User(bart):
    usaCitizen: true
    firstName: Bart
    lastName: Simpson
    email: bart@simpson.com
    password: secret

User(maggie):
    usaCitizen: true
    firstName: Maggie
    lastName: Simpson
    email: maggie@simpson.com
    password: secret

Donation(a):
    amount : 210
    method : paypal

Donation(b):
    amount : 20
    method : cash

Donation(c):
    amount : 330
    method : cash

Donation(d):
    amount : 10
    method : paypal 
</code></pre>
	  </section>
	  <section data-tab="05" class="ui tab stacked moodle-book segment">
	     <h1>Exploring the API</h1>
<p>The project should build without error. Launch it and browse to the database in the usual way.</p>
<p>Also, in a browser, explore these urls:</p>
<ul>
<li><a href="http://localhost:9000/">http://localhost:9000/</a></li>
<li><a href="http://localhost:9000/api/users">http://localhost:9000/api/users</a></li>
<li><a href="http://localhost:9000/api/users/1">http://localhost:9000/api/users/1</a></li>
<li><a href="http://localhost:9000/api/users/2">http://localhost:9000/api/users/2</a></li>
<li><a href="http://localhost:9000/api/donations">http://localhost:9000/api/donations</a></li>
<li><a href="http://localhost:9000/api/donations/1">http://localhost:9000/api/donations/1</a></li>
<li><a href="http://localhost:9000/api/donations/2">http://localhost:9000/api/donations/2</a></li>
</ul>
<p>You should see listed the test data loaded from the yml file.</p>
<h2>Postman</h2>
<p>There are various tools for exploring APIs such as this. Visit this site here:</p>
<ul>
<li><a href="http://www.getpostman.com/">http://www.getpostman.com/</a></li>
</ul>
<p>Follow the instructions to download an install the Postman Chrome application. When you launch the app, you should see something like this:</p>
<p><img alt="" src="./img/03.png"></p>
<p>Entering one of the URLs above, you should see the response formatted as follows:</p>
<p><img alt="" src="./img/04.png"></p>
<p>Try a few other urls from the above list. Also, try a few unrecognised urls - and explore the raw and preview display options.</p>
	  </section>
	  <section data-tab="06" class="ui tab stacked moodle-book segment">
	     <h1>POST and DELETE</h1>
<p>So far you have experimented with GET commands. THe API we have developed also supports POST and DELETE. This is declared in the routes file:</p>
<pre><code>GET     /api/users                           DonationServiceAPI.users
GET     /api/users/{id}                      DonationServiceAPI.user
POST    /api/users                           DonationServiceAPI.createUser
DELETE  /api/users/{id}                      DonationServiceAPI.deleteUser

GET     /api/donations                       DonationServiceAPI.donations
GET     /api/donations/{id}                  DonationServiceAPI.donation
POST    /api/donations                       DonationServiceAPI.createDonation
DELETE  /api/donations/{id}                  DonationServiceAPI.deleteDonation
</code></pre>

<p>POST will create a user or donation, and DELETE will remove one.</p>
<p>POST and DELETE cannot be easily generated from a standard browser address bar (GET is the default). However this is where tools like Postman come into their own.</p>
<h2>POST</h2>
<p>Here is a JSON version of a User:</p>
<pre><code>{
  &quot;firstName&quot; : &quot;homer&quot;,
  &quot;lastName&quot;  : &quot;simpson&quot;,
  &quot;email&quot;     : &quot;homer@simpson.com&quot;,
  &quot;password&quot;  : &quot;secret&quot;
}
</code></pre>

<p>In Postman, switch the HTTP request from GET to POST, and paste the above json into the 'raw' text box, selecting 'JSON' as the style.</p>
<p><img alt="" src="img/11.png"></p>
<p>In addition, you must select Headders: Content-Type = application/json. This parameter has also been selected in the above screen shot.</p>
<p>Press Send - and the application should respond with a copy of the object it has just created:</p>
<p><img alt="" src="img/12.png"></p>
<p>Also, check via a standard browser that the new object is being returned when we do a standard get form a browser address bar:</p>
<ul>
<li><a href="http://localhost:9000/api/users">http://localhost:9000/api/users</a></li>
</ul>
<h2>DELETE</h2>
<p>Now try a delete:</p>
<p><img alt="" src="img/13.png"></p>
<p>This time we have no parameters, just the ID of the user we want to delete. If it works (and a user with ID 1 exists), then we should get a 'success' response:</p>
<p><img alt="" src="img/14.png"></p>
<p>Verify, via a GET, that this user is in fact deleted.</p>
	  </section>
	  <section data-tab="Exercises" class="ui tab stacked moodle-book segment">
	     <h1>Exercises</h1>
<p>Archive of projects  so far:</p>
<ul>
<li><a href="archives/donation-service-play.zip">donation-service-play.zip</a></li>
</ul>
<h2>Exercise 1:</h2>
<p>You may notice that Postman remembers the various request you will have made:</p>
<p><img alt="" src="img/15.png"></p>
<p>You should be able to rerun each of them - or edit them to reflect different json objects.</p>
<h2>Exercise 2:</h2>
<p>Build some requests to create, delete and list Donations as well as Users.</p>
<h2>Exercise 3:</h2>
<p>Explore the 'Collections' feature of Postman. This will enable you to archive and recover various requests - which can be useful for test purposes.</p>
	  </section>
<script>

function addCaptions() {
  var images = $(".moodle-book img");
  jQuery.each(images, function(i)  {
    if((images[i].alt).length > 0) 
    {
      var div_img = $(document.createElement("div")).addClass("ui segment");
      $(images[i]).wrap(div_img);
      var div_label = $(document.createElement("div")).addClass("ui ribbon teal top attached label");
      div_label.append(images[i].alt);
      $(div_label).insertBefore(images[i]);
    }
  });
};

// Need to check if we have already been loaded
seen = 0;

$(document).ready(function()
{ 
  if (seen == 0)
  { 
    // not loaded before - so do the restyling once (need to moodle book print)
    $(".moodle-book img").addClass ("ui image");
    $(".moodle-book pre").addClass ("ui segment");
    addCaptions();
    seen = 1;
  }


})</script>
  <br>  
  <div class="ui fixed bottom borderless menu">'
    <div class="ui small item"> 
    <p id="footertext">
    Prepared by  Eamonn de Leastar (edeleastar@tssg.wit.ie) & John Fitzgerald (johnjfitzgerald@outlook.com). Except where otherwise noted, this content is licensed under a  
     <a  href="http://creativecommons.org/licenses/by-nc/4.0/" title="External link to http://creativecommons.org/licenses/by-nc/4.0/" 
       target="_blank">Creative Commons Attribution-NonCommercial 4.0 License
     </a>
     </p>
    </div>
  </div>   
    
  <script>
    $(document).ready(function()
    {  
      $('.tab-menu.menu .item').tab();
    });
  </script>   
  </body>
 </html>