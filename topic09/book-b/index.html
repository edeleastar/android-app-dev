 <!DOCTYPE html>
 <html>
   <head>

     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">

     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/semantic.min.css" type="text/css">
     <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/solarized_light.min.css" rel="stylesheet" />

     <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/semantic.min.js"></script>
     <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/highlight.min.js"></script>
     <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/languages/java.min.js"></script>
     <script>hljs.initHighlightingOnLoad();</script>

      <style>


body 
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
}

figcaption
{
  margin-bottom: 20px;
}

.vertical-align
{
  display: flex;
  align-items: center;
}

.credits
{
  min-height:20px;
}
    </style>

  </head>

  <body>

  <div class="ui container">
<style>


code
{
  font-family: "Monaco";
  font-size: 110%;
}

img
{
  padding:1px;
  border:1px solid black;
}

h1
{
  font-style:italic;
  font-size:130%;
  border-bottom: thin solid black;
}
h2
{
  font-size:110%;
  border-bottom: thin solid black;
}
h3
{
  font-size:100%;
  border-bottom: thin solid black;
}

</style>

<div class="ui fixed sticky top attached tabular menu labmenu">
   <header class="header item">
    <a href="../index.html">9: APIs & Camera </a>
  </header>
    <a class="active header item" data-tab="Donation-05">
        Donation-05
    </a>
      <a class="item" data-tab="01">
        01
      </a>
      <a class="item" data-tab="02">
        02
      </a>
      <a class="item" data-tab="03">
        03
      </a>
      <a class="item" data-tab="04">
        04
      </a>
      <a class="item" data-tab="05">
        05
      </a>
      <a class="item" data-tab="06">
        06
      </a>
      <a class="item" data-tab="Exercises">
        Exercises
      </a>
</div>

<br><br><br>

<div class="ui bottom attached tab segment lab" data-tab="Donation-05">
  <h1>Objectives</h1>
<p>Create a new standard java project specifically to test the API we have developed in donation-service-play project.</p>
</div>
<div class="ui bottom attached tab segment lab" data-tab="01">
  <h1>donation-service-test</h1>
<p>Create a new Java Project in eclipse - this time neither a play nor an Android app, just a simple Java Application. Call the Project donation-service-play-test"</p>
<p><img alt="" src="./img/05.png"></p>
<p>In the new project, select the project in Eclipse Package Explorer, right click, and select "Build Path-&gt;Configure Build Path"</p>
<p><img alt="" src="./img/06.png"></p>
<p>Under libraries, select "Add Library" and in subsequent select JUnit 4:</p>
<p><img alt="" src="./img/07.png"></p>
<p>This adds the JUnit library capability to our project.</p>
<p>Now download this archive here:</p>
<ul>
<li><a href="archives/lib.zip">lib.zip</a></li>
</ul>
<p>Expand the archive and drag/drop the folder into your project. It should now look like this:</p>
<p><img alt="" src="./img/08.png"></p>
<p>Select all of the imported jar files, right-click, and select 'Build Path-&gt;Add to Build Path'</p>
<p><img alt="" src="./img/09.png"></p>
<p>The project should now be configured thus:</p>
<p><img alt="" src="./img/10.png"></p>
</div>
<div class="ui bottom attached tab segment lab" data-tab="02">
  <h1>Model Classes</h1>
<h2>app.models</h2>
<p>In donation-service-test, create a new package called 'app.models'. Incorporate the following two classes into this package:</p>
<h3>User</h3>
<pre><code>package app.model;

import com.google.common.base.Objects;
import static com.google.common.base.Objects.toStringHelper;

public class User 
{
  public Long   id;
  public String firstName;
  public String lastName;
  public String email;
  public String password;

  public User()
  {}

  public User(String firstName, String lastName, String email, String password)
  {
    this.firstName = firstName;
    this.lastName  = lastName;
    this.email     = email;
    this.password  = password;
  } 

  @Override
  public boolean equals(final Object obj)
  {
    if (obj instanceof User)
    {
      final User other = (User) obj;
      return Objects.equal(firstName,  other.firstName) 
          &amp;&amp; Objects.equal(lastName,   other.lastName)
          &amp;&amp; Objects.equal(email,      other.email)
          &amp;&amp; Objects.equal(password,   other.password);                               
    }
    else
    {
      return false;
    }
  }  

  @Override
  public String toString()
  {
    return toStringHelper(this).addValue(id)
                               .addValue(firstName)
                               .addValue(lastName)
                               .addValue(password)
                               .addValue(email)  
                               .toString();
  }
}
</code></pre>

<h3>Donation</h3>
<pre><code>package app.model;

import static com.google.common.base.Objects.toStringHelper;

import com.google.common.base.Objects;

public class Donation
{
  public Long   id;
  public int    amount;
  public String method;

  public Donation()
  {}

  public Donation (int amount, String method)
  {
    this.amount = amount;
    this.method = method;
  }

  public String toString()
  {
    return toStringHelper(this).addValue(id)
                .addValue(amount)
                .addValue(method) 
                .toString();
  }

  @Override
  public boolean equals(final Object obj)
  {
    if (obj instanceof Donation)
    {
      final Donation other = (Donation) obj;
      return Objects.equal(amount ,  other.amount) 
          &amp;&amp; Objects.equal(method,   other.method);                            
    }
    else
    {
      return false;
    }
  }   
}

</code></pre>
</div>
<div class="ui bottom attached tab segment lab" data-tab="03">
  <h2>API Classes</h2>
<p>In donation-service-test, create a new package called 'app.api'. Incorporate the following three classes into this package:</p>
<p>Note: we will explore the structure of these classes in the lectures.</p>
<h3>Rest</h3>
<pre><code>package app.api;

import org.apache.http.HttpResponse;
import org.apache.http.client.methods.HttpDelete;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.client.methods.HttpPut;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.BasicResponseHandler;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.params.BasicHttpParams;
import org.apache.http.params.HttpConnectionParams;
import org.apache.http.params.HttpParams;

public class Rest
{
  private static DefaultHttpClient httpClient = null;
  private static final String URL = &quot;http://localhost:9000&quot;;

  private static DefaultHttpClient httpClient()
  {
    if (httpClient == null)
    {
      HttpParams httpParameters = new BasicHttpParams();
      HttpConnectionParams.setConnectionTimeout(httpParameters, 10000);
      HttpConnectionParams.setSoTimeout(httpParameters, 10000);
      httpClient = new DefaultHttpClient(httpParameters);
    }
    return httpClient;
  }

  public static String get(String path) throws Exception
  {
    HttpGet getRequest = new HttpGet(URL + path);
    getRequest.setHeader(&quot;accept&quot;, &quot;application/json&quot;);
    HttpResponse response = httpClient().execute(getRequest);
    return new BasicResponseHandler().handleResponse(response);
  }

  public static String delete(String path) throws Exception
  {
    HttpDelete deleteRequest = new HttpDelete(URL + path);
    HttpResponse response = httpClient().execute(deleteRequest);
    return new BasicResponseHandler().handleResponse(response);
  }

  public static String put(String path, String json) throws Exception
  {
    HttpPut putRequest = new HttpPut(URL + path);
    putRequest.setHeader(&quot;Content-type&quot;, &quot;application/json&quot;);
    putRequest.setHeader(&quot;accept&quot;, &quot;application/json&quot;);

    StringEntity s = new StringEntity(json);
    s.setContentEncoding(&quot;UTF-8&quot;);
    s.setContentType(&quot;application/json&quot;);
    putRequest.setEntity(s);

    HttpResponse response = httpClient().execute(putRequest);
    return new BasicResponseHandler().handleResponse(response);
  }

  public static String post(String path, String json) throws Exception
  {
    HttpPost putRequest = new HttpPost(URL + path);
    putRequest.setHeader(&quot;Content-type&quot;, &quot;application/json&quot;);
    putRequest.setHeader(&quot;accept&quot;, &quot;application/json&quot;);

    StringEntity s = new StringEntity(json);
    s.setContentEncoding(&quot;UTF-8&quot;);
    s.setContentType(&quot;application/json&quot;);
    putRequest.setEntity(s);

    HttpResponse response = httpClient().execute(putRequest);
    return new BasicResponseHandler().handleResponse(response);
  }
}
</code></pre>

<h3>JsonParsers</h3>
<pre><code>package app.api;

import java.util.List;
import java.util.ArrayList;

import app.model.Donation;
import app.model.User;
import flexjson.JSONDeserializer;
import flexjson.JSONSerializer;

public class JsonParsers
{
  public static JSONSerializer userSerializer     = new JSONSerializer().exclude(&quot;class&quot;)
                                                                        .exclude(&quot;persistent&quot;)
                                                                        .exclude(&quot;entityId&quot;); 
  public static JSONSerializer donationSerializer = new JSONSerializer().exclude(&quot;class&quot;)
                                                                        .exclude(&quot;persistent&quot;)
                                                                        .exclude(&quot;entityId&quot;); 

  public static User json2User(String json)
  {
    return new JSONDeserializer&lt;User&gt;().deserialize(json, User.class); 
  }

  public static List&lt;User&gt; json2Users(String json)
  {
    return new JSONDeserializer&lt;ArrayList&lt;User&gt;&gt;().use(&quot;values&quot;, User.class)
                                                  .deserialize(json);
  }

  public static String user2Json(Object obj)
  {
    return userSerializer.serialize(obj);
  }

  public static List&lt;User&gt; users2Json(String json)
  {
    return new JSONDeserializer&lt;ArrayList&lt;User&gt;&gt;().use(&quot;values&quot;, User.class)
                                                  .deserialize(json);
  } 


  public static Donation json2Donation(String json)
  {
    return  new JSONDeserializer&lt;Donation&gt;().deserialize(json, Donation.class);    
  }

  public static String donation2Json(Object obj)
  {
    return donationSerializer.serialize(obj);
  }  

  public static List&lt;Donation&gt; json2Donations(String json)
  {
    return new JSONDeserializer&lt;ArrayList&lt;Donation&gt;&gt;().use(&quot;values&quot;, Donation.class)
        .deserialize(json);
  }  
}
</code></pre>

<h2>DonationServiceAPI</h2>
<pre><code>package app.api;

import java.util.List;

import app.model.Donation;
import app.model.User;

public class DonationServiceAPI
{ 
  public static List&lt;User&gt; getUsers() throws Exception
  {
    String response =  Rest.get(&quot;/api/users&quot;);
    List&lt;User&gt; userList = JsonParsers.json2Users(response);
    return userList;
  }

  public static User getUser(Long id) throws Exception
  {
    String response =  Rest.get(&quot;/api/users/&quot; + id);
    User user = JsonParsers.json2User(response);
    return user;
  }

  public static User createUser(User user) throws Exception
  {
    String response = Rest.post (&quot;/api/users&quot;, JsonParsers.user2Json(user));
    return JsonParsers.json2User(response);
  }

  public static void deleteUser(User user) throws Exception
  {
    Rest.delete (&quot;/api/users/&quot; + user.id);
  }  
}
</code></pre>
</div>
<div class="ui bottom attached tab segment lab" data-tab="04">
  <h1>Unit Tests</h1>
<p>Create another folder called 'app.test', and incorporate this class:</p>
<pre><code>package app.test;

import java.util.List;
import org.junit.Test;
import app.api.DonationServiceAPI;
import app.model.User;

public class UserTest
{

  @Test
  public void testList() throws Exception
  {
    List&lt;User&gt; list = DonationServiceAPI.getUsers();
    System.out.println(list);
  }
}
</code></pre>

<p>Your project should now look like this:</p>
<p><img alt="" src="img/11.png"></p>
<p>The class we have just introduced is a simple unit test.</p>
<p>Make sue the donation-service-play app is running, and run the above test. To run the test, right click on the UserTest class and select 'Run as-&gt;JUnit Test'</p>
<p>After perhaps a slight delay if this is the first time you have launched the app, you should see the test runner 'green bar':</p>
<p><img alt="" src="img/12.png"></p>
<p>And the console window might contain the users retrieved by the api call:</p>
<p><img alt="" src="img/13.png"></p>
<p>Think carefully about what we have just done.</p>
<ul>
<li>A standalone app - donation-play-service - is running on localhost:9000 exposing a simple API</li>
<li>A separate app launches and issues a request to that API using '/users' url.</li>
<li>The returned list is displayed on the console.</li>
</ul>
</div>
<div class="ui bottom attached tab segment lab" data-tab="05">
  <h1>User Tests</h1>
<p>Exploring DonationServiceAPI, we can see there are several methods in here that may be useful:</p>
<pre><code>public class DonationServiceAPI
{ 
  public static List&lt;User&gt; getUsers() throws Exception
  {
   //...
  }

  public static User getUser(Long id) throws Exception
  {
   //...
  }

  public static User createUser(User user) throws Exception
  {
   //...
  }

  public static void deleteUser(User user) throws Exception
  {
   //...
  }
</code></pre>

<p>We can use these to compose some tests:</p>
<pre><code>package app.test;

import static org.junit.Assert.*;

import java.util.List;

import org.junit.Test;

import app.api.DonationServiceAPI;
import app.model.User;

public class UserTest
{
  @Test
  public void testCreate() throws Exception
  {
    User john = new User(&quot;john&quot;, &quot;doe&quot;, &quot;john@doe.com&quot;, &quot;secret&quot;);
    User user = DonationServiceAPI.createUser(john);
    assertEquals(john, user);
  }

  @Test
  public void testGet() throws Exception
  {
    User homer = new User(&quot;Homer&quot;, &quot;Simpson&quot;, &quot;homer@simpson.com&quot;, &quot;secret&quot;);
    User searchUser = DonationServiceAPI.getUser(1l);
    assertEquals(homer, searchUser);
  }
}
</code></pre>

<p>Run this test - we would expect it to pass. Explore the API directly (or via postman)</p>
<ul>
<li><a href="http://localhost:9000/api/users">http://localhost:9000/api/users</a></li>
</ul>
<p>You should be able to see a new user created by the tests. You will also perhaps see duplicates if you run the test a few times.</p>
</div>
<div class="ui bottom attached tab segment lab" data-tab="06">
  <h1>Structured User Tests</h1>
<p>In the play app, comment our or delete the Bootstrap task that loads the yaml data. We would like the application to start with a blank database (otherwise the tests will be hard to manage)</p>
<p>In our UserTest class, put some fixtures in the class we will use to exercise the API:</p>
<pre><code>public class UserTest
{
  static User userArray [] = 
  { 
    new User (&quot;homer&quot;,  &quot;simpson&quot;, &quot;homer@simpson.com&quot;,  &quot;secret&quot;),
    new User (&quot;lisa&quot;,   &quot;simpson&quot;, &quot;lisa@simpson.com&quot;,   &quot;secret&quot;),
    new User (&quot;maggie&quot;, &quot;simpson&quot;, &quot;maggie@simpson.com&quot;, &quot;secret&quot;),
    new User (&quot;bart&quot;,   &quot;simpson&quot;, &quot;bart@simpson.com&quot;,   &quot;secret&quot;),
    new User (&quot;marge&quot;,  &quot;simpson&quot;, &quot;marge@simpson.com&quot;,  &quot;secret&quot;),
  };

  List &lt;User&gt; userList = new ArrayList&lt;&gt;();
</code></pre>

<p>The introduce setup/teardown methods which will populate/depopulate the service using the above fixture</p>
<pre><code>  @Before
  public void setup() throws Exception
  { 
    for (User user : userArray)
    {
      User returned = DonationServiceAPI.createUser(user);
      userList.add(returned);
    }
  }

  @After
  public void teardown() throws Exception
  {
    for (User user : userList)
    {
      DonationServiceAPI.deleteUser(user);
    }
  }
</code></pre>

<p>Finally, bring in these unit tests:</p>
<pre><code>  @Test
  public void testCreate () throws Exception
  {
    assertEquals (userArray.length, userList.size());
    for (int i=0; i&lt;userArray.length; i++)
    {
      assertEquals(userList.get(i), userArray[i]);
    }
  }

  @Test
  public void testList() throws Exception
  {
    List&lt;User&gt; list = DonationServiceAPI.getUsers();
    assertTrue (list.containsAll(userList));
  }

  @Test
  public void testDelete () throws Exception
  {
    List&lt;User&gt; list1 = DonationServiceAPI.getUsers();
    User testUser = new User(&quot;mark&quot;,  &quot;simpson&quot;, &quot;marge@simpson.com&quot;,  &quot;secret&quot;);
    User returnedUser = DonationServiceAPI.createUser(testUser);
    List&lt;User&gt; list2 = DonationServiceAPI.getUsers();
    assertEquals (list1.size()+1, list2.size());
    DonationServiceAPI.deleteUser(returnedUser);
    List&lt;User&gt; list3 = DonationServiceAPI.getUsers();
    assertEquals (list1.size(), list3.size());
  }
</code></pre>

<p>Theses tests should all pass.</p>
<p>Examine closely the last test.</p>
</div>
<div class="ui bottom attached tab segment lab" data-tab="Exercises">
  <h1>Exercises</h1>
<p>Archive of the two projects so far:</p>
<ul>
<li><a href="archives/donation-service-play.zip">donation-service-play.zip</a></li>
<li><a href="archives/donation-service-play-test.zip">donation-service-play-test.zip</a></li>
</ul>
<h2>Exercise 1:</h2>
<p>Consider writing some more User tests. Look back at last weeks lab for inspiration of one or two more useful tests you might compose.</p>
<h2>Exercise 2:</h2>
<p>Look carefully at the UserTest and also the methods in DonationServiceAPI.</p>
<p>Now consider how you might extent the DonationServiceAPI class to allow access to donations as well as users. The code changes are entirely restricted to the DonationServiceAPI class, there will be no need to change the play project.</p>
<p>Now, build a new rest class - DonationTest - to exercises the api. Use UserTest as a role model for writing these tests.</p>
</div>
<script>
$('.ui.menu .item')
  .tab({
    history: true,
    historyType: 'hash'
  })
;
</script>
   </div>



  <br><br>
  <div class="ui bottom fixed borderless menu">
    <div class="ui small item">
    <p id="footertext">
    Prepared by  Eamonn de Leastar (edeleastar@tssg.wit.ie) & John Fitzgerald (johnjfitzgerald@outlook.com). Except where otherwise noted, this content is licensed under a
     <a  href="http://creativecommons.org/licenses/by-nc/4.0/" title="External link to http://creativecommons.org/licenses/by-nc/4.0/"
       target="_blank">Creative Commons Attribution-NonCommercial 4.0 License
     </a>
     </p>
    </div>
  </div>    <script>

$(document).ready(function()
{
  $("img").addClass ("ui image");

  var images = $(".lab img");
  jQuery.each(images, function(i)  {
    if((images[i].alt).length > 0)
    {
      var div_img = $(document.createElement("div")).addClass("ui segment");
      $(images[i]).wrap(div_img);
      var div_label = $(document.createElement("div")).addClass("ui ribbon teal top attached label");
      div_label.append(images[i].alt);
      $(div_label).insertBefore(images[i]);
    }
  });
})    </script>

  </body>
 </html>