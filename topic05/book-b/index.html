 <!DOCTYPE html>
 <html>
   <head>
     <meta charset="utf-8" />
     <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
   
     <title> MyRent-05 </title>
   
     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

     <link rel="stylesheet" href="http://cdn.jsdelivr.net/semantic-ui/0.19.3/css/semantic.min.css">
     <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script> 
     <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
     <script src="http://cdn.jsdelivr.net/semantic-ui/0.19.3/javascript/semantic.min.js"></script>
 
     <link href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/solarized_light.min.css" rel="stylesheet" /> 
     <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/highlight.min.js"></script>
     <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/languages/java.min.js"></script>
     <script>hljs.initHighlightingOnLoad();</script>

    <style>


body 
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
  font-size: 14px
}

code
{
	font-family: "Monaco";
	font-size: 110%;
}

h1 
{
  font-style:italic;
  font-size:120%;
  border-bottom: thin solid black;
}
h2 
{
  font-size:110%;
  border-bottom: thin solid black;
}
h3 
{
  font-size:100%;
  border-bottom: thin solid black;
}

#footertext 
{
  font-size:70%
}


#title 
{
  font-size:120%;
  color: black;
  text-align: right;
  background-color : white;
}

img 
{
   padding:1px;
  /* border:1px solid black;*/
   margin-top: 10px;
   margin-bottom: 10px;
}

header img
{
	 padding:1px;
   border:0px solid black;
}

header h1
{
  font-style:normal;
  font-size:120%;
  border-bottom: 0px;
}

header h2
{
  font-style:normal;
  font-size:100%;
  border-bottom: 0px;
}

header h3
{
  font-style:normal;
  font-size:90%;
  border-bottom: 0px;
}

    </style>

  </head>
  <body>
  <nav class="ui fixed top pointing borderless inverted menu">
    <header class="header item"> <a href="../index.html">5: File IO, Navigation & Implicit Intents</a></header>
    <div class="right tab-menu menu">
          <a class="item" data-tab="MyRent-05"> MyRent-05 </a>
          <a class="item" data-tab="01"> 01 </a>
          <a class="item" data-tab="02"> 02 </a>
          <a class="item" data-tab="03"> 03 </a>
          <a class="item" data-tab="04"> 04 </a>
          <a class="item" data-tab="05"> 05 </a>
          <a class="item" data-tab="Archives"> Archives </a>
    </div>
  </nav>

  <br>

	  <section data-tab="MyRent-05" class="ui tab stacked moodle-book segment">
	     <h1>Contact list &amp; Email support</h1>
<p>Activities within an application can reach out to activities in other applications to perform specific tasks. In this lab we introduce two new features - selecting a contact from the phone's contact lists, and sending an email to the selected user. Both of these features require the usage of 'implicit' intents.</p>
	  </section>
	  <section data-tab="01" class="ui tab stacked moodle-book segment">
	     <h1>Resources</h1>
<p>In preparing for our new features, we define some strings to be used by the application. This step is not strictly necessary - but taking this approach is considered best practice, and enables the application to be internationalized more easily.</p>
<p>These are the new strings:</p>
<h2>res/strings.xml</h2>
<pre><code>  &lt;string name=&quot;landlord&quot;&gt;Prospective Tenant&lt;/string&gt;
  &lt;string name=&quot;residence_report&quot;&gt;Send Residence Information&lt;/string&gt;

  &lt;string name=&quot;residence_report_rented&quot;&gt;The residence is already let.&lt;/string&gt;
  &lt;string name=&quot;residence_report_not_rented&quot;&gt;The residence is still available.&lt;/string&gt;
  &lt;string name=&quot;residence_report_nobody_interested&quot;&gt;there is no other prospective tentant at this time.&lt;/string&gt;
  &lt;string name=&quot;residence_report_prospective_tenant&quot;&gt;the prospective tenant is %s.&lt;/string&gt;
  &lt;string name=&quot;residence_report_subject&quot;&gt;Status Report on Residence Availability&lt;/string&gt;
  &lt;string name=&quot;send_report&quot;&gt;Send residence report via&lt;/string&gt;   
</code></pre>

<p>We need 2 new buttons which will enable the user to select a contact, and send an email:</p>
<p><img alt="Figure 1: Prospective Tenant &amp; Send Residence Information Buttons added" src="img/01.png"></p>
<p>These are the button characteristics:</p>
<h2>res/layout/activity_residence.xml</h2>
<pre><code>    &lt;Button
        android:id=&quot;@+id/tenant&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:layout_marginLeft=&quot;16dp&quot;
        android:layout_marginRight=&quot;16dp&quot;
        android:text=&quot;@string/landlord&quot; /&gt;  

    &lt;Button android:id=&quot;@+id/residence_reportButton&quot;
          android:layout_width=&quot;match_parent&quot;
          android:layout_height=&quot;wrap_content&quot;
          android:layout_marginLeft=&quot;16dp&quot;
          android:layout_marginRight=&quot;16dp&quot;
          android:text=&quot;@string/residence_report&quot;
        /&gt; 
</code></pre>
	  </section>
	  <section data-tab="02" class="ui tab stacked moodle-book segment">
	     <h1>Helpers</h1>
<p>Our IntentHelper class is a useful location for methods that involved intents, either explicit or implicit. Here we introduce two new methods to trigger contact list and email access:</p>
<h2>IntentHelper</h2>
<pre><code>  public static void selectContact(Activity parent, int id)
  {
    Intent selectContactIntent = new Intent(Intent.ACTION_PICK, ContactsContract.Contacts.CONTENT_URI);
    parent.startActivityForResult(selectContactIntent, id);
  }

  public static void sendEmail(Context context, String email, String subject, String body)
  {
    Intent emailIntent = new Intent(Intent.ACTION_SENDTO, Uri.fromParts(&quot;mailto&quot;, email, null));
    emailIntent.putExtra(Intent.EXTRA_SUBJECT, subject);
    emailIntent.putExtra(Intent.EXTRA_TEXT, body);
    context.startActivity(Intent.createChooser(emailIntent, &quot;Sending Email&quot;));
  }
</code></pre>

<p>The import statements for the above:</p>
<pre><code>import android.provider.ContactsContract;
import android.content.Context;
import android.net.Uri;
</code></pre>

<p>We will make use of these in the next step.</p>
<h2>ContactHelper</h2>
<p>Accessing the phone's contact list is can be complex - requiring us to engage with the 'Content Provider' API for the Contact List. Having this awkward code in our activities can make them hard to read - so we resort to another helper:</p>
<pre><code>package org.wit.android.helpers;

import android.content.Context;
import android.content.Intent;
import android.database.Cursor;
import android.net.Uri;
import android.provider.ContactsContract;
import android.content.ContentResolver;


public class ContactHelper
{ 
  public static String getDisplayName(Context context, Intent data)
  {
    String contact = &quot;unable to find contact&quot;;
    Uri contactUri = data.getData();
    String[] queryFields = new String[] { ContactsContract.Contacts.DISPLAY_NAME };
    Cursor c = context.getContentResolver().query(contactUri, queryFields, null, null, null);
    if (c.getCount() == 0)
    {
      c.close();
      return contact;
    }
    c.moveToFirst();
    contact = c.getString(0);
    c.close();

    return contact;
  }

  public static String getEmail(Context context, Intent data)
  {
    String email = &quot;no email&quot;;

    Uri contactUri = data.getData();
    ContentResolver cr = context.getContentResolver();

    Cursor cur = cr.query(contactUri, null, null, null, null);

    if (cur.getCount() &gt; 0)
    {
      try
      {
        cur.moveToFirst();
        String contactId = cur.getString(cur.getColumnIndex(ContactsContract.Contacts._ID));
        Cursor emails = cr.query(ContactsContract.CommonDataKinds.Email.CONTENT_URI, null,
            ContactsContract.CommonDataKinds.Email.CONTACT_ID + &quot; = &quot; + contactId, null, null);
        emails.moveToFirst();
        email = emails.getString(emails.getColumnIndex(ContactsContract.CommonDataKinds.Email.DATA));
        emails.close();
      }
      catch (Exception e)
      {
      }
    }
    return email;
  }
}
</code></pre>

<p>The above is fairly crudely implemented - we can either get uses 'Diaplay Name' or their 'Email' - but not both.</p>
	  </section>
	  <section data-tab="03" class="ui tab stacked moodle-book segment">
	     <h1>Residence</h1>
<p>The Residence model class will need to be extended to include a new field (the tennant) and also a new method - to generate a report. First introduce these imports:</p>
<pre><code>import org.wit.myrent.R;
import android.content.Context;
</code></pre>

<p>This is the new field:</p>
<pre><code>public String  tenant;
</code></pre>

<p>... and to keep serialization on track - an identifier for this field:</p>
<pre><code>  private static final String JSON_TENANT         = &quot;tenant&quot;;  
</code></pre>

<p>... which will need to be engaged in the constructor:</p>
<pre><code>    tenant        = json.getString(JSON_TENANT);
</code></pre>

<p>... and the serialization itself:</p>
<pre><code>    json.put(JSON_TENANT        , tenant);
</code></pre>

<p>Finally, a new method to generate the contents of the email:</p>
<pre><code>  public String getResidenceReport(Context context)
  {
    String rentedString = null;
    if (rented)
    {
      rentedString = context.getString(R.string.residence_report_rented);
    }
    else
    {
      rentedString = context.getString(R.string.residence_report_not_rented);
    }
    String dateFormat = &quot;EEE, MMM dd&quot;;
    String dateString = android.text.format.DateFormat.format(dateFormat, date).toString();
    String prospectiveTenant = tenant;
    if (tenant == null)
    {
      prospectiveTenant = context.getString(R.string.residence_report_nobody_interested);
    }
    else
    {
      prospectiveTenant = context.getString(R.string.residence_report_prospective_tenant, tenant);
    }
    String report =  &quot;Location &quot; + geolocation + &quot; Date: &quot; + dateString + &quot; &quot; + rentedString + &quot; &quot; + prospectiveTenant;
    return report;
  }
</code></pre>
	  </section>
	  <section data-tab="04" class="ui tab stacked moodle-book segment">
	     <h1>ResidenceActivity - Tenant</h1>
<p>We can then start to wire up a "Select Tenant" button.</p>
<p>The imports:</p>
<pre><code>import static org.wit.android.helpers.ContactHelper.getContact;
import static org.wit.android.helpers.IntentHelper.selectContact;
import android.content.Intent;
</code></pre>

<p>An ID we will use for the implicit Intent:</p>
<pre><code>private static final int REQUEST_CONTACT = 1;
</code></pre>

<p>The button to trigger the intent:</p>
<pre><code>private Button   tenantButton;
</code></pre>

<p>Initialization of the button:</p>
<pre><code>tenantButton = (Button)   findViewById(R.id.tenant);
</code></pre>

<p>Its event handler set up:</p>
<pre><code>tenantButton.setOnClickListener(this);
</code></pre>

<p>And then the event handler itself:</p>
<pre><code>  @Override
  public void onClick(View v)
  {
    switch (v.getId())
    {
      //...

      case R.id.tenant                 : selectContact(this, REQUEST_CONTACT);
                                         break;                                       
    }
  }
</code></pre>

<p>This last method will trigger a 'startActivityForResult' - which we will have to deal with in order to recover the actual contact. This will be provided by the following new method:</p>
<pre><code>  @Override
  public void onActivityResult(int requestCode, int resultCode, Intent data)
  {
    switch (requestCode)
    {
      case REQUEST_CONTACT    : String name= getContact(this, data);
                                residence.tenant = name;
                                tenantButton.setText(name);      
                                break;
    }
  }  
</code></pre>

<p>Note that the above passes the data we received from the Contact List activity to our helper, which will recover the actual email address.</p>
	  </section>
	  <section data-tab="05" class="ui tab stacked moodle-book segment">
	     <h1>ResidenceActivity - Email</h1>
<p>Now we can engage the report button to actually send the email.</p>
<p>The imports:</p>
<pre><code>import static org.wit.android.helpers.IntentHelper.sendEmail;
</code></pre>

<p>The Button object:</p>
<pre><code>private Button   reportButton;
</code></pre>

<p>Initialisation of the button:</p>
<pre><code>reportButton = (Button)   findViewById(R.id.residence_reportButton);
</code></pre>

<p>Enabling the event handler:</p>
<pre><code>reportButton.setOnClickListener(this);
</code></pre>

<p>The event handler itself:</p>
<pre><code>  @Override
  public void onClick(View v)
  {
    switch (v.getId())
    {
      //...

      case R.id.residence_reportButton : sendEmail(this, &quot;&quot;, getString(R.string.residence_report_subject), residence.getResidenceReport(this));                           
                                         break;                                         
    }
  }
</code></pre>

<p>Test this now. Make sure the contact you select actually has an email address in the contact info.</p>
<p>If gmail is the default mail handling app, it may look like this:</p>
<p><img alt="Figure 1: Sample Email" src="img/02.png"></p>
	  </section>
	  <section data-tab="Archives" class="ui tab stacked moodle-book segment">
	     <h1>Archives</h1>
<p>This is a version of MyRent complete to the end if this lab:</p>
<ul>
<li><a href="archives/MyRentV05.zip">MyRentV05</a></li>
</ul>
	  </section>
<script>

function addCaptions() {
  var images = $(".moodle-book img");
  jQuery.each(images, function(i)  {
    if((images[i].alt).length > 0) 
    {
      var div_img = $(document.createElement("div")).addClass("ui segment");
      $(images[i]).wrap(div_img);
      var div_label = $(document.createElement("div")).addClass("ui ribbon teal top attached label");
      div_label.append(images[i].alt);
      $(div_label).insertBefore(images[i]);
    }
  });
};

// Need to check if we have already been loaded
seen = 0;

$(document).ready(function()
{ 
  if (seen == 0)
  { 
    // not loaded before - so do the restyling once (need to moodle book print)
    $(".moodle-book img").addClass ("ui image");
    $(".moodle-book pre").addClass ("ui segment");
    addCaptions();
    seen = 1;
  }


})</script>
  <br>  
  <div class="ui fixed bottom borderless menu">'
    <div class="ui small item"> 
    <p id="footertext">
    Prepared by  Eamonn de Leastar (edeleastar@tssg.wit.ie) & John Fitzgerald (johnjfitzgerald@outlook.com). Except where otherwise noted, this content is licensed under a  
     <a  href="http://creativecommons.org/licenses/by-nc/4.0/" title="External link to http://creativecommons.org/licenses/by-nc/4.0/" 
       target="_blank">Creative Commons Attribution-NonCommercial 4.0 License
     </a>
     </p>
    </div>
  </div>   
    
  <script>
    $(document).ready(function()
    {  
      $('.tab-menu.menu .item').tab();
    });
  </script>   
  </body>
 </html>