 <!DOCTYPE html>
 <html>
   <head>
     <meta charset="utf-8" />
     <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
   
     <title> Donation-07 </title>
   
     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

     <link rel="stylesheet" href="http://beta.semantic-ui.com/dist/semantic.min.css">
     <script src="http://beta.semantic-ui.com/javascript/library/jquery.min.js"></script>
     <script src="http://beta.semantic-ui.com/dist/semantic.min.js"></script>

     <link href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/solarized_light.min.css" rel="stylesheet" /> 
     <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/highlight.min.js"></script>
     <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/languages/java.min.js"></script>
     <script>hljs.initHighlightingOnLoad();</script>

    <style>


body 
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
}

#container
{
  margin :10px
}

code
{
	font-family: "Monaco";
	font-size: 110%;
}

h1 
{
  font-style:italic;
  font-size:120%;
  border-bottom: thin solid black;
}
h2 
{
  font-size:110%;
  border-bottom: thin solid black;
}
h3 
{
  font-size:100%;
  border-bottom: thin solid black;
}

#footertext 
{
  font-size:70%
}

#title 
{
  font-size:120%;
  color: black;
  text-align: right;
  background-color : white;
}

img 
{
   padding:1px;
   border:1px solid black;
   margin-top: 10px;
   margin-bottom: 10px;
}

header img
{
	 padding:1px;
   border:0px solid black;
}

header h1
{
  font-style:normal;
  font-size:120%;
  border-bottom: 0px;
}

header h2
{
  font-style:normal;
  font-size:100%;
  border-bottom: 0px;
}

header h3
{
  font-style:normal;
  font-size:90%;
  border-bottom: 0px;
}

.cover
{
    width: 290px;
    height: 290px;
    border:1px solid lightgray;
}
.image-thumbnail
{
    height: 100%;
    background-size: cover;
    -moz-background-size: cover;
    -webkit-background-size: cover;
    background-position: center;
}



    </style>

  </head>
  <body>
  <nav class="ui fixed top pointing borderless inverted menu">
    <header class="header item"> <a href="../index.html">10: REST</a></header>
    <div class="right tab-menu menu">
          <a class="item" data-tab="Donation-07"> Donation-07 </a>
          <a class="item" data-tab="01"> 01 </a>
          <a class="item" data-tab="02"> 02 </a>
          <a class="item" data-tab="03"> 03 </a>
          <a class="item" data-tab="04"> 04 </a>
          <a class="item" data-tab="05"> 05 </a>
          <a class="item" data-tab="06"> 06 </a>
          <a class="item" data-tab="Exercises"> Exercises </a>
    </div>
  </nav>

  <br>

	  <section data-tab="Donation-07" class="ui tab stacked moodle-book segment">
	     <h1>Objectives</h1>
<p>Reintroduce the Donation Android app, refactor it to interact with the donation-play-service</p>
	  </section>
	  <section data-tab="01" class="ui tab stacked moodle-book segment">
	     <h1>Donation-android app</h1>
<p>This is the donation android app as we left it with Donation-03 lab:</p>
<p><a href="archives/donation-android-v3.zip">donation-android-v3.zip</a></p>
<p>Import this into your eclipse environment and make sure it compiles and launches successfully.</p>
<h2>Libraries</h2>
<p>There is a folder in the project called 'libs'.  Download and copy this jar into libs:</p>
<ul>
<li><a href="archives/flexjson-2.1.jar">flexjson-2.1.jar</a></li>
</ul>
<p>and he add it to build path (right click and add to build path in Eclipse)</p>
	  </section>
	  <section data-tab="02" class="ui tab stacked moodle-book segment">
	     <h1>app.http</h1>
<p>Create a new package in the android app called app.http, and introduce these classes:</p>
<h2>Response</h2>
<pre><code class="java">package app.http;

import java.util.List;

public interface Response&lt;T&gt;
{
  public void setReponse(List&lt;T&gt; aList);
  public void setReponse(T anObject);
  public void errorOccurred (Exception e);
}
</code></pre>

<h2>Request</h2>
<pre><code class="java">package app.http;

import java.util.List;
import android.app.ProgressDialog;
import android.content.Context;
import android.os.AsyncTask;

@SuppressWarnings(&quot;rawtypes&quot;)
public abstract class Request extends AsyncTask&lt;Object, Void, Object&gt;
{
  public Response         responder;
  public ProgressDialog   dialog;
  public Context          context;
  public String           message;
  public Exception        error;

  public Request(Context context, Response responder, String message)
  {
    this.responder = responder;
    this.context = context;
    this.message = message;
  }

  @Override
  protected void onPreExecute()
  {
    super.onPreExecute();
    this.dialog = new ProgressDialog(context, 1);
    this.dialog.setMessage(message);
    this.dialog.show();
  }

  @Override
  protected  Object doInBackground(Object... params)
  {
    error = null;
    try
    {
      return doRequest(params);
    }
    catch (Exception e)
    {
      error = e;
    }
    return null;
  }

  protected abstract  Object doRequest(Object... params) throws Exception;

  @SuppressWarnings(&quot;unchecked&quot;)
  @Override
  protected void onPostExecute(Object result)
  {
    super.onPostExecute(result);
    if (dialog.isShowing())
    {
      dialog.dismiss();
    }
    if (error != null)
    {
      responder.errorOccurred(error);  
    }
    else
    {
      if (result instanceof List)
      {
        responder.setReponse((List)result);
      }
      else
      {
        responder.setReponse(result);
      }
    }
  } 
}
</code></pre>

<h2>Rest</h2>
<pre><code class="java">package app.http;

import org.apache.http.HttpResponse;
import org.apache.http.client.methods.HttpDelete;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.client.methods.HttpPut;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.BasicResponseHandler;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.params.BasicHttpParams;
import org.apache.http.params.HttpConnectionParams;
import org.apache.http.params.HttpParams;

public class Rest
{
  private static DefaultHttpClient httpClient = null;
  private static final String URL = &quot;http://10.0.3.2:9000&quot;;

  private static DefaultHttpClient httpClient()
  {
    if (httpClient == null)
    {
      HttpParams httpParameters = new BasicHttpParams();
      HttpConnectionParams.setConnectionTimeout(httpParameters, 10000);
      HttpConnectionParams.setSoTimeout(httpParameters, 10000);
      httpClient = new DefaultHttpClient(httpParameters);
    }
    return httpClient;
  }

  public static String get(String path) throws Exception
  {
    HttpGet getRequest = new HttpGet(URL + path);
    getRequest.setHeader(&quot;accept&quot;, &quot;application/json&quot;);
    HttpResponse response = httpClient().execute(getRequest);
    return new BasicResponseHandler().handleResponse(response);
  }

  public static String delete(String path) throws Exception
  {
    HttpDelete deleteRequest = new HttpDelete(URL + path);
    HttpResponse response = httpClient().execute(deleteRequest);
    return new BasicResponseHandler().handleResponse(response);
  }

  public static String put(String path, String json) throws Exception
  {
    HttpPut putRequest = new HttpPut(URL + path);
    putRequest.setHeader(&quot;Content-type&quot;, &quot;application/json&quot;);
    putRequest.setHeader(&quot;accept&quot;, &quot;application/json&quot;);

    StringEntity s = new StringEntity(json);
    s.setContentEncoding(&quot;UTF-8&quot;);
    s.setContentType(&quot;application/json&quot;);
    putRequest.setEntity(s);

    HttpResponse response = httpClient().execute(putRequest);
    return new BasicResponseHandler().handleResponse(response);
  }

  public static String post(String path, String json) throws Exception
  {
    HttpPost putRequest = new HttpPost(URL + path);
    putRequest.setHeader(&quot;Content-type&quot;, &quot;application/json&quot;);
    putRequest.setHeader(&quot;accept&quot;, &quot;application/json&quot;);

    StringEntity s = new StringEntity(json);
    s.setContentEncoding(&quot;UTF-8&quot;);
    s.setContentType(&quot;application/json&quot;);
    putRequest.setEntity(s);

    HttpResponse response = httpClient().execute(putRequest);
    return new BasicResponseHandler().handleResponse(response);
  }
}
</code></pre>
	  </section>
	  <section data-tab="03" class="ui tab stacked moodle-book segment">
	     <h1>Models - API Classes</h1>
<p>We already have a models package - introduce these new classes into this package:</p>
<h2>JsonParsers</h2>
<pre><code class="java">package app.models;

import java.util.List;
import java.util.ArrayList;
import flexjson.JSONDeserializer;
import flexjson.JSONSerializer;

public class JsonParsers
{
  public static JSONSerializer userSerializer     = new JSONSerializer().exclude(&quot;class&quot;)
                                                                        .exclude(&quot;persistent&quot;)
                                                                        .exclude(&quot;entityId&quot;); 
  public static JSONSerializer donationSerializer = new JSONSerializer().exclude(&quot;class&quot;)
                                                                        .exclude(&quot;persistent&quot;)
                                                                        .exclude(&quot;entityId&quot;); 

  public static User json2User(String json)
  {
    return new JSONDeserializer&lt;User&gt;().deserialize(json, User.class); 
  }

  public static List&lt;User&gt; json2Users(String json)
  {
    return new JSONDeserializer&lt;ArrayList&lt;User&gt;&gt;().use(&quot;values&quot;, User.class)
                                                  .deserialize(json);
  }

  public static String user2Json(Object obj)
  {
    return userSerializer.serialize(obj);
  }

  public static List&lt;User&gt; users2Json(String json)
  {
    return new JSONDeserializer&lt;ArrayList&lt;User&gt;&gt;().use(&quot;values&quot;, User.class)
                                                  .deserialize(json);
  } 


  public static Donation json2Donation(String json)
  {
    return  new JSONDeserializer&lt;Donation&gt;().deserialize(json, Donation.class);    
  }

  public static String donation2Json(Object obj)
  {
    return donationSerializer.serialize(obj);
  }  

  public static List&lt;Donation&gt; json2Donations(String json)
  {
    return new JSONDeserializer&lt;ArrayList&lt;Donation&gt;&gt;().use(&quot;values&quot;, Donation.class)
        .deserialize(json);
  }  
}
</code></pre>

<h2>DonationServiceAPI</h2>
<pre><code class="java">package app.models;

import java.util.List;
import android.content.Context;
import app.http.Request;
import app.http.Response;
import app.http.Rest;

public class DonationServiceAPI
{ 
  public static void getUsers(Context context, Response&lt;User&gt; response, String dialogMesssage)
  {
    new GetUsers(context, response, dialogMesssage).execute();
  }

  public static void createUser(Context context, Response&lt;User&gt; response, String dialogMesssage, User user)
  {
    new CreateUser(context, response, dialogMesssage).execute(user);
  }

  public static void getDonations(Context context, Response&lt;Donation&gt; response, String dialogMesssage)
  {
    new GetDonations(context, response, dialogMesssage).execute();
  }

  public static void createDonation(Context context, Response&lt;Donation&gt; response, String dialogMesssage, Donation donation)
  {
    new CreateDonation(context, response, dialogMesssage).execute(donation);
  }
}

class GetUsers extends Request
{
  public GetUsers(Context context, Response&lt;User&gt; callback, String message)
  {
    super(context, callback, message);
  }

  @Override
  protected List&lt;User&gt; doRequest(Object... params) throws Exception
  {
    String response =  Rest.get(&quot;/api/users&quot;);
    List&lt;User&gt; userList = JsonParsers.json2Users(response);
    return userList;
  }
}

class GetDonations extends Request
{
  public GetDonations(Context context, Response&lt;Donation&gt; callback, String message)
  {
    super(context, callback, message);
  }

  @Override
  protected List&lt;Donation&gt; doRequest(Object... params) throws Exception
  {
    String response =  Rest.get(&quot;/api/donations&quot;);
    List&lt;Donation&gt; donationList = JsonParsers.json2Donations(response);
    return donationList;
  }
}

class CreateUser extends Request
{ 
  public CreateUser(Context context, Response&lt;User&gt; callback, String message)
  {
    super(context, callback, message);
  }

  @Override
  protected User doRequest(Object... params) throws Exception
  {
    String response = Rest.post (&quot;/api/users&quot;, JsonParsers.user2Json(params[0]));
    return JsonParsers.json2User(response);
  }
}

class CreateDonation extends Request
{
  public CreateDonation(Context context, Response&lt;Donation&gt; callback, String message)
  {
    super(context, callback, message);
  }

  @Override
  protected Donation doRequest(Object... params) throws Exception
  {
    String response = Rest.post (&quot;/api/donations&quot;, JsonParsers.donation2Json(params[0]));
    return JsonParsers.json2Donation(response);
  }
}
</code></pre>
	  </section>
	  <section data-tab="04" class="ui tab stacked moodle-book segment">
	     <h1>Models - User &amp; Donation</h1>
<p>The curret User and Donation classes need some minor adjustments. Specifically, we need to include the following in both:</p>
<ul>
<li>id</li>
<li>default (no argument) constructor</li>
</ul>
<h2>User</h2>
<pre><code>package app.models;

public class User 
{
  public Long   id;
  public String firstName;
  public String lastName;
  public String email;
  public String password;

  public User()
  {}

  public User(String firstName, String lastName, String email, String password)
  {
    this.firstName = firstName;
    this.lastName = lastName;
    this.email = email;
    this.password = password;
  } 
}
</code></pre>

<h2>Donation</h2>
<pre><code>package app.models;

public class Donation
{
  public Long   id;
  public int    amount;
  public String method;

  Donation()
  {}

  public Donation (int amount, String method)
  {
    this.amount = amount;
    this.method = method;
  }

  public String toString()
  {
    return amount + &quot;, &quot; + method;
  }
}
</code></pre>
	  </section>
	  <section data-tab="05" class="ui tab stacked moodle-book segment">
	     <h1>Login Activity</h1>
<p>This is a restructuring of Login to fetch the users from the donation-service as soon as the activity starts, and then to handle the response appropriately.</p>
<pre><code class="java">package app.activities;

import java.util.List;
import android.os.Bundle;
import android.app.Activity;
import android.content.Intent;
import android.view.View;
import android.widget.TextView;
import android.widget.Toast;
import app.donation.R;
import app.http.Response;
import app.main.DonationApp;
import app.models.DonationServiceAPI;
import app.models.User;

public class Login extends Activity implements Response&lt;User&gt;
{
  @Override
  protected void onCreate(Bundle savedInstanceState)
  {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_login);

    DonationServiceAPI.getUsers(this, this, &quot;Retrieving list of users&quot;);
  }

  public void signinPressed (View view) 
  {
    DonationApp app = (DonationApp) getApplication();

    TextView email     = (TextView)  findViewById(R.id.loginEmail);
    TextView password  = (TextView)  findViewById(R.id.loginPassword);

    if (app.validUser(email.getText().toString(), password.getText().toString()))
    {
      startActivity (new Intent(this, Donate.class));
    }
    else
    {
      Toast toast = Toast.makeText(this, &quot;Invalid Credentials&quot;, Toast.LENGTH_SHORT);
      toast.show();
    }
  }

  @Override
  public void setResponse(List&lt;User&gt; aList)
  {
    DonationApp app = (DonationApp) getApplication();
    app.users = aList;
  }

  @Override
  public void errorOccurred(Exception e)
  {
    Toast toast = Toast.makeText(this, &quot;Donation Service Unavailable. Try again later&quot;, Toast.LENGTH_LONG);
    toast.show();
    startActivity (new Intent(this, Welcome.class));
  }

  @Override
  public void setResponse(User anObject)
  {}
}
</code></pre>

<h1>Running the application</h1>
<p>The last step to getting the project running is to specifically enable Internet access for your app. This is controlled by a single entry in the AndroidManifest.xml file:</p>
<pre><code>    &lt;uses-permission android:name=&quot;android.permission.INTERNET&quot;/&gt;
</code></pre>

<p>Try the app now (make sure donation-service play app is running). It should let you log in with user credentials download from the service (try homer@simpson.com, secret - without registering).</p>
	  </section>
	  <section data-tab="06" class="ui tab stacked moodle-book segment">
	     <h1>Report</h1>
<p>Finally, the report activity:</p>
<pre><code class="java">package app.activities;

import java.util.List;
import app.donation.R;
import app.http.Response;
import app.main.DonationApp;
import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ArrayAdapter;
import android.widget.ListView;
import android.widget.TextView;
import android.widget.Toast;
import app.models.Donation;
import app.models.DonationServiceAPI;

public class Report extends Activity implements Response &lt;Donation&gt;
{
  private ListView        listView;
  private DonationApp     app;
  private DonationAdapter adapter; 

  @Override
  public boolean onCreateOptionsMenu(Menu menu)
  {
    getMenuInflater().inflate(R.menu.report, menu);
    return true;
  }

  @Override
  public boolean onOptionsItemSelected(MenuItem item)
  {
    switch (item.getItemId())
    {
      case R.id.menuDonate : startActivity (new Intent(this, Donate.class));
                             break;
      case R.id.menuLogout : startActivity (new Intent(this, Welcome.class));
                             break;                               
    }
    return true;
  }  

  @Override
  public void onCreate(Bundle savedInstanceState)
  {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_report);

    app = (DonationApp) getApplication();

    listView = (ListView) findViewById(R.id.reportList);
    adapter = new DonationAdapter (this, app.donations);

    listView.setAdapter(adapter);

    DonationServiceAPI.getDonations(this, this, &quot;Downloading Donations List..&quot;);
  }

  @Override
  public void setResponse(List&lt;Donation&gt; aList)
  {
    app.donations     = aList;
    adapter.donations = aList;
    adapter.notifyDataSetChanged();
  }

  @Override
  public void setResponse(Donation anObject)
  {
  }

  @Override
  public void errorOccurred(Exception e)
  {
    Toast toast = Toast.makeText(this, &quot;Donation Service Unavailable!&quot;, Toast.LENGTH_LONG);
    toast.show();
    startActivity (new Intent(this, Welcome.class));
  }
}

class DonationAdapter extends ArrayAdapter&lt;Donation&gt;
{
  private Context        context;
  public  List&lt;Donation&gt; donations;

  public DonationAdapter(Context context, List&lt;Donation&gt; donations)
  {
    super(context, R.layout.row_donate, donations);
    this.context   = context;
    this.donations = donations;
  }

  @Override
  public View getView(int position, View convertView, ViewGroup parent)
  {
    LayoutInflater inflater = (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);

    View     view       = inflater.inflate(R.layout.row_donate, parent, false);
    Donation donation   = donations.get(position);
    TextView amountView = (TextView) view.findViewById(R.id.row_amount);
    TextView methodView = (TextView) view.findViewById(R.id.row_method);

    amountView.setText(&quot;&quot; + donation.amount);
    methodView.setText(donation.method);

    return view;
  }

  @Override
  public int getCount()
  {
    return donations.size();
  }
}
</code></pre>

<p>When this starts - it requests the donations from the service. When they arrive, they are displayed in the list view.</p>
	  </section>
	  <section data-tab="Exercises" class="ui tab stacked moodle-book segment">
	     <h1>Exercises</h1>
<p>Archive of project so far:</p>
<ul>
<li><a href="archives/donation-android-v4.zip">donation-android-v4.zip</a></li>
</ul>
<h2>Exercise 1: Heroku</h2>
<p>Publish the donation-service app to Heroku. Using the url of the heroku app, change the Rest URL:</p>
<pre><code>public class Rest
{
  private static DefaultHttpClient httpClient = null;
  private static final String URL = &quot;http://10.0.3.2:9000&quot;;
  //...
</code></pre>

<p>... to your deployed app. See if your android app now reads from the heroku</p>
<h2>Exercise 2:</h2>
<p>The application as it currently stands uses two aspects of the donation play application:</p>
<ul>
<li>Let users log in who are already 'registered' online</li>
<li>Display a list of donations downloaded form the web service</li>
</ul>
<p>See if you can figure out how to:</p>
<ul>
<li>when users sign up, their details are send to the donation-service play app</li>
<li>when a donation is made, it is sent to the donation-service play app</li>
</ul>
<p>The facilities are already in the play app for this, so you will only be making changes to the android application.</p>
<p>Because the donation-service play app has no UI, keep an eye on the database via the database browser in the usual way:</p>
<ul>
<li><a href="http://localhost/@db">http://localhost/@db</a></li>
</ul>
	  </section>
<script>

function addCaptions() {
  var images = $(".moodle-book img");
  jQuery.each(images, function(i)  {
    if((images[i].alt).length > 0) 
    {
      var div_img = $(document.createElement("div")).addClass("ui segment");
      $(images[i]).wrap(div_img);
      var div_label = $(document.createElement("div")).addClass("ui ribbon teal top attached label");
      div_label.append(images[i].alt);
      $(div_label).insertBefore(images[i]);
    }
  });
};

// Need to check if we have already been loaded
seen = 0;

$(document).ready(function()
{ 
  if (seen == 0)
  { 
    // not loaded before - so do the restyling once (need to moodle book print)
    $(".moodle-book img").addClass ("ui image");
    $(".moodle-book pre").addClass ("ui segment");
    addCaptions();
    seen = 1;
  }


})</script>
  <br>  
  <div class="ui fixed bottom borderless menu">'
    <div class="ui small item"> 
    <p id="footertext">
    Prepared by  Eamonn de Leastar (edeleastar@tssg.wit.ie) & John Fitzgerald (johnjfitzgerald@outlook.com). Except where otherwise noted, this content is licensed under a  
     <a  href="http://creativecommons.org/licenses/by-nc/4.0/" title="External link to http://creativecommons.org/licenses/by-nc/4.0/" 
       target="_blank">Creative Commons Attribution-NonCommercial 4.0 License
     </a>
     </p>
    </div>
  </div>   
    
  <script>
    $(document).ready(function()
    {  
      $('.tab-menu.menu .item').tab();
    });
  </script>   
  </body>
 </html>