 <!DOCTYPE html>
 <html>
   <head>
     <meta charset="utf-8" />
     <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
   
     <title> MyRent-08 </title>
   
     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

     <link rel="stylesheet" href="http://beta.semantic-ui.com/dist/semantic.min.css">
     <script src="http://beta.semantic-ui.com/javascript/library/jquery.min.js"></script>
     <script src="http://beta.semantic-ui.com/dist/semantic.min.js"></script>

     <link href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/solarized_light.min.css" rel="stylesheet" /> 
     <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/highlight.min.js"></script>
     <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/languages/java.min.js"></script>
     <script>hljs.initHighlightingOnLoad();</script>

    <style>


body 
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
}

#container
{
  margin :10px
}

code
{
	font-family: "Monaco";
	font-size: 110%;
}

h1 
{
  font-style:italic;
  font-size:120%;
  border-bottom: thin solid black;
}
h2 
{
  font-size:110%;
  border-bottom: thin solid black;
}
h3 
{
  font-size:100%;
  border-bottom: thin solid black;
}

#footertext 
{
  font-size:70%
}

#title 
{
  font-size:120%;
  color: black;
  text-align: right;
  background-color : white;
}

img 
{
   padding:1px;
   border:1px solid black;
   margin-top: 10px;
   margin-bottom: 10px;
}

header img
{
	 padding:1px;
   border:0px solid black;
}

header h1
{
  font-style:normal;
  font-size:120%;
  border-bottom: 0px;
}

header h2
{
  font-style:normal;
  font-size:100%;
  border-bottom: 0px;
}

header h3
{
  font-style:normal;
  font-size:90%;
  border-bottom: 0px;
}

.cover
{
    width: 290px;
    height: 290px;
    border:1px solid lightgray;
}
.image-thumbnail
{
    height: 100%;
    background-size: cover;
    -moz-background-size: cover;
    -webkit-background-size: cover;
    background-position: center;
}



    </style>

  </head>
  <body>
  <nav class="ui fixed top pointing borderless inverted menu">
    <header class="header item"> <a href="../index.html">7: TDD | Embedded Map & Orientation</a></header>
    <div class="right tab-menu menu">
          <a class="item" data-tab="MyRent-08"> MyRent-08 </a>
          <a class="item" data-tab="01"> 01 </a>
          <a class="item" data-tab="02"> 02 </a>
          <a class="item" data-tab="03"> 03 </a>
          <a class="item" data-tab="04"> 04 </a>
          <a class="item" data-tab="05"> 05 </a>
          <a class="item" data-tab="06"> 06 </a>
          <a class="item" data-tab="07"> 07 </a>
          <a class="item" data-tab="08"> 08 </a>
          <a class="item" data-tab="09"> 09 </a>
          <a class="item" data-tab="10"> 10 </a>
          <a class="item" data-tab="Archives"> Archives </a>
    </div>
  </nav>

  <br>

	  <section data-tab="MyRent-08" class="ui tab stacked moodle-book segment">
	     <h1>Embedded Map &amp; Orientation</h1>
<ul>
<li>
<p>Introduce a Google Map including necessary supporting resources such as Google Play Services Library and a personal API key.</p>
</li>
<li>
<p>Presently the app has been developed to run in portrait mode. Here shall develop a landscape layout.</p>
</li>
<li>
<p>Additional minor features include validation of geolocation input and immediate mirroring any changes in this input in the view title.</p>
</li>
<li>
<p>Finally, to allow the app to run on small devices, the details view will be made scrollable in both portrait and landscape modes.</p>
</li>
</ul>
	  </section>
	  <section data-tab="01" class="ui tab stacked moodle-book segment">
	     <h1>Preview</h1>
<p>Here we shall embed a Google map in the ResidenceFragment class. This entails using:</p>
<ul>
<li>Google Play Services Library and</li>
<li>A Google API key</li>
<li>Modifying the XML layout</li>
<li>Adding the necessary Java code</li>
</ul>
<p>The layout shall be refactored as shown here.</p>
<p><img alt="Figure 1: Embedding Google Map in ResidenceFragment" src="img/17.png"></p>
<p>Additionally, we shall: </p>
<ul>
<li>Make the non-map part of the details view scrollable.</li>
<li>Modify a copy of the layout suitable to display the details view in landscape mode.</li>
</ul>
<p><img alt="Figure 2: Landscape mode added. Landscape and Portrait scrollable" src="img/27.png"></p>
<p>The instructions in this lab refer to development in <em>debug mode</em>. This means that the application you develop will not be suitable to publish on Play. Further information is available about this topic is available <a href="http://developer.android.com/tools/publishing/app-signing.html">here</a> and <a href="http://developer.android.com/distribute/tools/launch-checklist.html">here</a>.</p>
	  </section>
	  <section data-tab="02" class="ui tab stacked moodle-book segment">
	     <h1>Google Play</h1>
<p>It is necessary to add Google Play Services to the project.</p>
<ul>
<li>Launch Eclipse and open the workspace where you are developing MyRent.</li>
<li>
<p>Open the Android SDK Manager and install Google Play Services:</p>
<ul>
<li>To do this, tick the checkbox in the Extras folder opposite Google Play Services and then press the Install Package button</li>
</ul>
<p><img alt="Figure 1: Using Android SDK Manager to download Google Play Services" src="img/01.png"></p>
</li>
<li>
<p>When Play Services installation is complete select menu commands:</p>
<ul>
<li>Import | Android | Existing Android Code into Workspace:</li>
</ul>
<p><img alt="Figure 2: Importing Android Code" src="img/02.png"></p>
<ul>
<li>Browse to where you have installed Android SDK and then to <ul>
<li>/extras/google/google_play_services/libproject/google-play-services_lib/</li>
<li><strong>Important</strong>: tick the <em>Copy projects into workspace</em> check box in the Import Projects window as shown in Figure 4.</li>
<li>Press Finish
<img alt="Figure 3: Locate Play Services with the Android SDK install" src="img/03.png">
<img alt="Figure 4: Copy Play Services into workspace" src="img/04.png"></li>
</ul>
</li>
<li>Open the file <em>google-play-services_lib/AndroidManifest.xml</em> and change the minSdkVersion to 16 to correspond with the minimum version we are targetting in MyRent
<img alt="Figure 5: Google Services manifest file" src="img/05.png"></li>
</ul>
</li>
</ul>
<pre><code>&lt;uses-sdk android:minSdkVersion=&quot;16&quot;/&gt;
</code></pre>

<ul>
<li>Add the following to MyRent AndroidManifest.xml file immediately before the closing <em>application</em> tag (as illustrated in Figure 6):</li>
</ul>
<pre><code>&lt;meta-data 
            android:name=&quot;com.google.android.gms.version&quot;
            android:value=&quot;@integer/google_play_services_version&quot;/&gt;  
</code></pre>

<p><img alt="Figure 6: Addition to manifest file to facilitate use of google play services library" src="img/22.png"></p>
<ul>
<li>When you have completed the above steps, reference the newly imported Play Services in MyRent project as follows:<ul>
<li>Highlight <em>myrent</em>, right click and select Properties in the context menu
<img alt="Figure 7: Open MyRent properties" src="img/06.png"></li>
<li>Select <em>google-play-services_lib</em> in the Project Selection window and press OK
<img alt="Figure 8: Select Play Services in Project Selection window" src="img/07.png"></li>
<li>The Properties for myrent window should now appear as shown in Figure 9.
<img alt="Figure 9: Play Services now referenced by MyRent" src="img/08.png"></li>
</ul>
</li>
</ul>
<p>MyRent project has now been set up to reference Google Play Services.</p>
<p>Official documentation is available at the <a href="https://developers.google.com/maps/documentation/android/start#overview">
Google Maps Android API v2</a> page.</p>
<p><strong>Important note:</strong> as an aid to portability it would help were you to locate the <em>google-play-services_lib</em> folder in the same containing folder as the MyRent project as shown here:
<img alt="" src="img/21.png"></p>
	  </section>
	  <section data-tab="03" class="ui tab stacked moodle-book segment">
	     <h1>API Key</h1>
<p>We recommend that you become familiar with the official documentation for <a href="https://developers.google.com/maps/documentation/android/start#overview">Google Maps Android API v2</a>.</p>
<p>It is necessary to obtain an API key before using the Google Maps API. This can be achieved as follows:</p>
<ul>
<li>You should already have imported Google Play Services to your <em>myrent</em> project in Eclipse.</li>
<li>
<p>Retrieve your SHA-1 Fingerprint</p>
<ul>
<li>A SHA-1 fingerprint is a unique text string required by Google Maps to  identify the application.</li>
<li>It can easily be obtained by opening the Preferences window and copying it from there to the required destination (see Figure 1).</li>
<li>The destination for the fingerprint will be described below. In the meantime copy the fingerprint to a newly created file named <em>myrent-keys.txt</em>.</li>
<li>Store the file <em>myrent-keys.txt</em> in a secure location and ensure you maintain a backup version.<ul>
<li>Failure to retain a copy of the keys would mean that you would no longer be able to make updates to the <em>myrent</em> application.
<img alt="Figure 1: SHA1 fingerprint" src="img/09.png"></li>
</ul>
</li>
</ul>
</li>
<li>
<p>Register a Google account (or use an existing one) and sign in.</p>
</li>
<li>Open the <a href="https://cloud.google.com/console">Google API Console</a><ul>
<li>Create a project named, for example, <em>myrent</em> (Figures 2 &amp; 3).</li>
</ul>
</li>
</ul>
<p><img alt="Figure 2: Create new project" src="img/10.png">
<img alt="Figure 3: New Project" src="img/11.png"></p>
<ul>
<li>Select Credentials in the Projects column and press the <em>Create new key</em> button (Figure 4).</li>
</ul>
<p><img alt="Figure 4: Create new key" src="img/12.png"></p>
<ul>
<li>The <em>Create a new key</em> window opens: press the <em>Android key</em> button (Figure 5).</li>
</ul>
<p><img alt="Figure 5: Create an Android key" src="img/13.png"></p>
<ul>
<li>A window similar to that illustrated in Figure 6 now opens:<ul>
<li>Paste the SHA-1 Fingerprint into the the area indicated, followed by a semi-colon, followed by the project package name.</li>
<li>Example: 45:B8:A9:...DE;org.wit.myrent</li>
<li>Press the Create button.</li>
</ul>
</li>
</ul>
<p><img alt="Figure 6: Create an Android key and configure allowed Android applications" src="img/14.png"></p>
<ul>
<li>A window showing the key and other relevant information should then appear as shown in Figure 7.</li>
</ul>
<p><img alt="Figure 7: Public API access" src="img/15.png"></p>
<ul>
<li>Switch on Google Maps Android API v2<ul>
<li>Select APIS &amp; AUTH and then APIs in the left-hand Projects column  scroll to Google Maps Android API v2</li>
<li>The button on the right should be off: if so, press it to turn it ON (Figure 8).</li>
</ul>
</li>
</ul>
<p><img alt="Figure 8: Turn on Google Maps Android API v2" src="img/16.png"></p>
<p>Here is a summary of the data that should be retained securely:</p>
<ul>
<li>The login | password pair for the Google account</li>
<li>The SHA-1 fingerprint</li>
<li>The API keys</li>
</ul>
	  </section>
	  <section data-tab="04" class="ui tab stacked moodle-book segment">
	     <h1>Resources (Manifest)</h1>
<p>In AndroidManifest.xml:</p>
<ul>
<li>Add GoogleMap permissions following the <em>uses-sdk</em> node:</li>
</ul>
<pre><code>  &lt;uses-permission android:name=&quot;android.permission.INTERNET&quot;/&gt;
  &lt;uses-permission android:name=&quot;android.permission.ACCESS_NETWORK_STATE&quot;/&gt;
  &lt;uses-permission android:name=&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;/&gt;
  &lt;!--  The following two permissions are not required to use
        Google Maps Android API v2, but are recommended. --&gt;
  &lt;uses-permission android:name=&quot;android.permission.ACCESS_COARSE_LOCATION&quot;/&gt;
  &lt;uses-permission android:name=&quot;android.permission.ACCESS_FINE_LOCATION&quot;/&gt;
</code></pre>

<ul>
<li>Immediately before the closing <em>application</em> tag add these metadata nodes:</li>
</ul>
<pre><code>    &lt;meta-data
      android:name=&quot;com.google.android.maps.v2.API_KEY&quot;
      android:value=&quot;TODO: Insert your API key here&quot; /&gt;

    &lt;meta-data 
      android:name=&quot;com.google.android.gms.version&quot;
      android:value=&quot;@integer/google_play_services_version&quot;/&gt;  
</code></pre>

<p>Replace the placeholder <strong>TODO: Inert your API key here</strong> with your key, created in an earlier step.</p>
<p>Verify that the Google Play Services library has been included by selecting the project name in Eclipse Package Explorer, right-click to open Properties window and then add <em>google_play_services_lib</em> as shown in Figure 1.</p>
<p><img alt="Figure 1: Add google play services library" src="img/18.png"></p>
<p>For reference here is the up-to-date manifest file:</p>
<pre><code>&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
  package=&quot;org.wit.myrent&quot;
  android:versionCode=&quot;1&quot;
  android:versionName=&quot;1.0&quot; &gt;

  &lt;uses-sdk
    android:minSdkVersion=&quot;16&quot;
    android:targetSdkVersion=&quot;19&quot; /&gt;

  &lt;uses-permission android:name=&quot;android.permission.INTERNET&quot;/&gt;
  &lt;uses-permission android:name=&quot;android.permission.ACCESS_NETWORK_STATE&quot;/&gt;
  &lt;uses-permission android:name=&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;/&gt;
  &lt;!--  The following two permissions are not required to use
        Google Maps Android API v2, but are recommended. --&gt;
  &lt;uses-permission android:name=&quot;android.permission.ACCESS_COARSE_LOCATION&quot;/&gt;
  &lt;uses-permission android:name=&quot;android.permission.ACCESS_FINE_LOCATION&quot;/&gt;

  &lt;application
    android:name=&quot;.app.MyRentApp&quot;
    android:allowBackup=&quot;true&quot;
    android:icon=&quot;@drawable/ic_launcher&quot;
    android:label=&quot;@string/app_name&quot;
    android:theme=&quot;@style/AppTheme&quot; &gt;


    &lt;activity
      android:name=&quot;.activities.ResidenceListActivity&quot;
      android:label=&quot;@string/app_name&quot; &gt;
      &lt;intent-filter&gt;
        &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;
        &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;
      &lt;/intent-filter&gt;
    &lt;/activity&gt;    

    &lt;activity 
        android:name=&quot;.activities.ResidencePagerActivity&quot;
        android:label=&quot;@string/app_name&quot;&gt;

        &lt;meta-data  
          android:name=&quot;android.support.PARENT_ACTIVITY&quot;
          android:value=&quot;.activities.ResidenceListActivity&quot;/&gt;
    &lt;/activity&gt;  

    &lt;meta-data 
            android:name=&quot;com.google.android.gms.version&quot;
            android:value=&quot;@integer/google_play_services_version&quot;/&gt;  

    &lt;meta-data
      android:name=&quot;com.google.android.maps.v2.API_KEY&quot;
      android:value=&quot;&lt;TODO: Insert your API key here&quot; /&gt;

    &lt;meta-data 
      android:name=&quot;com.google.android.gms.version&quot;
      android:value=&quot;@integer/google_play_services_version&quot;/&gt;     
  &lt;/application&gt;

&lt;/manifest&gt;
</code></pre>
	  </section>
	  <section data-tab="05" class="ui tab stacked moodle-book segment">
	     <h1>Resources (Layout)</h1>
<p>Refactor the layout of the detail view:</p>
<p><img alt="Figure 1: ResidenceFragment layout" src="img/17.png"></p>
<p>Filename: fragment_residence.xml</p>
<pre><code>&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    android:layout_width=&quot;match_parent&quot;
    android:layout_height=&quot;match_parent&quot;
    android:orientation=&quot;vertical&quot; &gt;   
  &lt;LinearLayout
      android:layout_width=&quot;match_parent&quot;
      android:layout_height=&quot;0dp&quot;
      android:layout_weight=&quot;60&quot;
      android:baselineAligned=&quot;false&quot;
      android:orientation=&quot;vertical&quot; &gt;      
     &lt;!-- LOCATION --&gt;
     &lt;TextView
       android:layout_width=&quot;match_parent&quot;
       android:layout_height=&quot;wrap_content&quot;
       android:text=&quot;@string/location&quot;
       style=&quot;?android:listSeparatorTextViewStyle&quot;/&gt; 
      &lt;LinearLayout
         android:layout_width=&quot;match_parent&quot;
         android:layout_height=&quot;wrap_content&quot;
         android:orientation=&quot;horizontal&quot; 
         android:baselineAligned=&quot;false&quot; &gt;

      &lt;!-- Geolocation (GPS Coords) --&gt;      
      &lt;LinearLayout
        android:layout_width=&quot;0dp&quot;
        android:layout_height=&quot;match_parent&quot;
        android:layout_weight=&quot;60&quot;
        android:orientation=&quot;vertical&quot; &gt;  
      &lt;TextView
        android:layout_width=&quot;wrap_content&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:layout_marginLeft=&quot;10dp&quot;
        android:text=&quot;@string/geolocation&quot; /&gt;

      &lt;EditText   
        android:id=&quot;@+id/geolocation&quot;
        android:layout_width=&quot;wrap_content&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:hint=&quot;@string/geolocation_hint&quot; &gt;
        &lt;requestFocus /&gt;   
      &lt;/EditText&gt; 
    &lt;/LinearLayout&gt; 
    &lt;!-- Show Map Button --&gt;          
    &lt;LinearLayout
      android:layout_width=&quot;0dp&quot;
      android:layout_height=&quot;match_parent&quot;
      android:layout_weight=&quot;40&quot;
      android:orientation=&quot;vertical&quot; &gt;

      &lt;Button
          android:id=&quot;@+id/show_map&quot;
          android:layout_width=&quot;wrap_content&quot;
          android:layout_height=&quot;wrap_content&quot;
          android:layout_marginLeft=&quot;16dp&quot;
          android:layout_marginRight=&quot;16dp&quot;
          android:layout_marginTop=&quot;16dp&quot;
          android:enabled=&quot;false&quot; /&gt;

      &lt;/LinearLayout&gt;   
    &lt;/LinearLayout&gt;   
    &lt;!-- STATUS --&gt;   
    &lt;TextView
      android:layout_width=&quot;match_parent&quot;
      android:layout_height=&quot;wrap_content&quot;
      android:text=&quot;@string/status&quot;
      style=&quot;?android:listSeparatorTextViewStyle&quot;/&gt; 
    &lt;Button android:id=&quot;@+id/registration_date&quot;
      android:layout_width=&quot;match_parent&quot;
      android:layout_height=&quot;wrap_content&quot;
      android:layout_marginLeft=&quot;16dp&quot;
      android:layout_marginRight=&quot;16dp&quot; /&gt;
    &lt;CheckBox
        android:id=&quot;@+id/isrented&quot;
      android:layout_width=&quot;wrap_content&quot;
      android:layout_height=&quot;wrap_content&quot;
      android:enabled=&quot;true&quot;
        android:focusable=&quot;false&quot;
      android:gravity=&quot;center&quot;
      android:text=&quot;@string/rented_checkbox_text&quot;/&gt;
    &lt;Button
      android:id=&quot;@+id/tenant&quot;
      android:layout_width=&quot;match_parent&quot;
      android:layout_height=&quot;wrap_content&quot;
      android:layout_marginLeft=&quot;16dp&quot;
      android:layout_marginRight=&quot;16dp&quot;
      android:text=&quot;@string/landlord&quot; /&gt;  

    &lt;Button android:id=&quot;@+id/residence_reportButton&quot;
      android:layout_width=&quot;match_parent&quot;
      android:layout_height=&quot;wrap_content&quot;
      android:layout_marginLeft=&quot;16dp&quot;
      android:layout_marginRight=&quot;16dp&quot;
      android:text=&quot;@string/residence_report&quot;/&gt; 
  &lt;/LinearLayout&gt;   
  &lt;LinearLayout
    android:layout_width=&quot;match_parent&quot;
    android:layout_height=&quot;0dp&quot;
    android:layout_weight=&quot;40&quot;
    android:baselineAligned=&quot;false&quot;
    android:orientation=&quot;vertical&quot; &gt;

    &lt;FrameLayout
        android:id=&quot;@+id/map&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;0dp&quot;
        android:layout_weight=&quot;0.88&quot; /&gt;
  &lt;/LinearLayout&gt;
&lt;/LinearLayout&gt;
</code></pre>

<p>Figure 2 should help you to understand the changes made here.</p>
<p><img alt="Figure 2: Refactored layout" src="img/23.png"></p>
	  </section>
	  <section data-tab="06" class="ui tab stacked moodle-book segment">
	     <h1>Model</h1>
<p>Before we introduce the map code we shall modify the Residence model class allowing it to store the current zoom level of the map.</p>
<ul>
<li>The purpose is to ensure that the zoom level is retained as one switches between the list and detail views.</li>
</ul>
<p>Here are the code snippets to be added to Residence.java:</p>
<pre><code>    //New fields
    public double  zoom       ;//zoom level of accompanying map
    private static final String JSON_ZOOM           = &quot;zoom&quot;          ; //map zoom level

</code></pre>

<p>Constructors:</p>
<pre><code>  public Residence()
  {
    ...
    zoom        = 16.0f;

  }

  public Residence(JSONObject json) throws JSONException
  {
    ...
    zoom          = json.getDouble(JSON_ZOOM);
  }
</code></pre>

<p>toJSON method</p>
<pre><code>  public JSONObject toJSON() throws JSONException
  {
    ...
    json.put(JSON_ZOOM          , zoom);

    return json;
  }
</code></pre>
	  </section>
	  <section data-tab="07" class="ui tab stacked moodle-book segment">
	     <h1>Helpers</h1>
<p>Add this helper class to the <em>org.wit.android.helpers</em> package:</p>
<pre><code>package org.wit.android.helpers;

import android.content.Context;
import com.google.android.gms.maps.model.LatLng;


public class MapHelper
{
  public static LatLng latLng(Context context, String geolocation)
  {
    String[] g = geolocation.split(&quot;,&quot;);
    if (g.length == 2)
    {
      return new LatLng(Double.parseDouble(g[0]), Double.parseDouble(g[1]));
    }
    return new LatLng(0, 0);

  }

  public static String latLng(LatLng geo)
  {

    return String.format(&quot;%.6f&quot;, geo.latitude) + &quot;, &quot; + String.format(&quot;%.6f&quot;, geo.longitude);
  }

}
</code></pre>

<p>The method <em>LatLng latLng(String geolocation)</em> returns a LatLng object containing the latitude and longitude coordinates contained in the <em>String geolocation</em>.</p>
<p>The method <em>String latLng(LatLng geo)</em> returns a single string version of the coordinates contained in a LatLng object formed by concatenating the coordinates but separating them with a comma. For example:</p>
<pre><code>52.253456,-7.187162
</code></pre>

<p><a href="https://developer.android.com/reference/com/google/android/gms/maps/model/LatLng.html">LatLng</a> is a Google class representing a pair of latitude and longitude coordinates stored as degrees.</p>
<p>Please note that the use of a Context type as an argument above is not necessary at this time. We are including it here because it will be required later when we introduce validation and wish to generate Toast messages.</p>
	  </section>
	  <section data-tab="08" class="ui tab stacked moodle-book segment">
	     <h1>ResidenceFragment</h1>
<p>Add imports</p>
<pre><code>import com.google.android.gms.maps.CameraUpdateFactory;
import com.google.android.gms.maps.GoogleMap;
import com.google.android.gms.maps.model.CameraPosition;
import com.google.android.gms.maps.model.LatLng;
import com.google.android.gms.maps.model.Marker;
import com.google.android.gms.maps.model.MarkerOptions;
import com.google.android.gms.maps.SupportMapFragment;

</code></pre>

<p>Add a method to initialize the map fragment:</p>
<pre><code>  private void initializeMapFragment()
  {
    FragmentManager fm = getChildFragmentManager();
    mapFragment = (SupportMapFragment) fm.findFragmentById(R.id.map);
    if (mapFragment == null)
    {
      mapFragment = SupportMapFragment.newInstance();
      fm.beginTransaction().replace(R.id.map, mapFragment).commit();
    }
  }
</code></pre>

<p>This fragment may be initialized only when the containing fragment has been created (ResidenceFragment).</p>
<ul>
<li>To do this we override <em>onActivityCreated</em>:</li>
</ul>
<pre><code>  @Override
  public void onActivityCreated(Bundle savedInstanceState) 
  {
    super.onActivityCreated(savedInstanceState);
    initializeMapFragment();
  }
</code></pre>

<p>Disable mapButton and associated statements:</p>
<p><del>    private Button mapButton;</p>
<p><del>    mapButton = (Button) v.findViewById(R.id.show_map);</p>
<p><del>    mapButton .setOnClickListener(this);</p>
<p>Add instance variables;</p>
<pre><code>  SupportMapFragment mapFragment;
  GoogleMap gmap;
  Marker marker;
  LatLng markerPosition;
  boolean markerDragged;
</code></pre>

<p>Note the boolean flag above (markerDragged).</p>
<ul>
<li>The flag is used to distinguish between geolocations input by the user and those generated by moving the marker.</li>
</ul>
<p>We use the flag to avoid conflict that would otherwise arise as follows:</p>
<ul>
<li>The geolocation EditText control listens for any inputs by the user.</li>
<li>When an input is detected the map immediately places a marker at this location and displays itself on the screen.</li>
<li>If a user then drags the marker, representing a new geolocation, the code writes this new position to the EditText box.</li>
<li>However, this change to the EditText box, without intervention, would trigger an unnecessary rendering of the map.</li>
</ul>
<p>To avoid this potential cyclical behaviour, replace the <em>afterTextChanged(Editable)</em> method with the following:</p>
<pre><code>  @Override
  public void afterTextChanged(Editable c)
  {
    String thisGeolocation = c.toString();
    Log.i(this.getClass().getSimpleName(), &quot;geolocation &quot; + thisGeolocation);
    residence.geolocation = thisGeolocation;
    getActivity().setTitle(thisGeolocation);
    // using a flag, markerDragged, to avoid race condition
    if (markerDragged == true)
    {
      markerDragged = false;
    }
    else
    {
      renderMap(MapHelper.latLng(getActivity(), thisGeolocation));
    }
  }
</code></pre>

<p>Change class signature to implement:</p>
<pre><code>GoogleMap.OnMarkerDragListener
GoogleMap.OnCameraChangeListener
</code></pre>

<p>New signature is:</p>
<pre><code>public class ResidenceFragment extends SupportMapFragment implements TextWatcher, 
                                                        OnCheckedChangeListener, 
                                                        OnClickListener, 
                                                        DatePickerDialog.OnDateSetListener,
                                                        GoogleMap.OnMarkerDragListener,
                                                        GoogleMap.OnCameraChangeListener

</code></pre>

<p>This change necessitates implementation of associated interface methods which you may use QuickFix to resolve:
<img alt="" src="img/19.png"></p>
<p>Here are the methods which we have, where applicable, fully implemented. First are the implementations of the OnMarkerDragListener interface:</p>
<pre><code>  @Override
  public void onMarkerDrag(Marker arg0)
  {
  }

  @Override
  public void onMarkerDragEnd(Marker arg0)
  {
    residence.geolocation = MapHelper.latLng(arg0.getPosition());
    getActivity().setTitle(residence.geolocation);
    gmap.animateCamera(CameraUpdateFactory.newLatLng(arg0.getPosition()));
    markerDragged = true;
  }

  @Override
  public void onMarkerDragStart(Marker arg0)
  {
  }

</code></pre>

<p>Here is the implementation of the <a href="http://developer.android.com/reference/com/google/android/gms/maps/GoogleMap.OnCameraChangeListener.html">OnCameraChangeListener</a>:</p>
<pre><code>  @Override
  public void onCameraChange(CameraPosition arg0)
  {
    residence.zoom = arg0.zoom;
    markerPosition = MapHelper.latLng(getActivity(), residence.geolocation);
    if (marker != null)
    {
      marker.remove();
      marker = null;
    }

    marker = gmap.addMarker(new MarkerOptions().position(markerPosition).draggable(true).title(&quot;Residence&quot;).alpha(0.7f)
        .snippet(&quot;GPS : &quot; + markerPosition.toString()));

  }
</code></pre>

<p>Next is the method to render the map:</p>
<pre><code>  private void renderMap(LatLng markerPosition)
  {
    if (mapFragment != null)
    {
      gmap = mapFragment.getMap();
      if (gmap != null)
      {
        gmap.animateCamera(CameraUpdateFactory.newLatLngZoom(markerPosition, (float) residence.zoom));
        gmap.setMapType(GoogleMap.MAP_TYPE_HYBRID);
        gmap.setOnMarkerDragListener(this);
        gmap.setOnCameraChangeListener(this);
      }
    }
  }
</code></pre>

<p>Next we override <em>onStart()</em> within which we invoke <em>renderMap</em> and register a listener to detect any changes to the map:</p>
<pre><code>  @Override
  public void onStart()
  {
    super.onStart();
    renderMap(MapHelper.latLng(getActivity(), residence.geolocation));
    gmap.setOnCameraChangeListener(this);
  }
</code></pre>

<p>Ensure that <em>super</em> is called in <em>onCreateView</em>:</p>
<pre><code>    super.onCreateView(inflater,  parent, savedInstanceState);
</code></pre>

<p>Test the app as follows:</p>
<ul>
<li>Create a new residence and check the details view.</li>
<li>Create a new residence and change the default geolocation. <ul>
<li>The marker and map should reflect the new geolocation.</li>
</ul>
</li>
<li>Change the zoom level, switch to the list view and back: the zoom level should be retained.</li>
</ul>
<p>If you modify the geolocation such that the input becomes invalid then the app will crash. Here is example of invalid data:</p>
<p><img alt="Figure 1: Example of invalid data" src="img/25.png"></p>
<p>We can solve this by introducing a <em>try-catch</em> block to <em>MapHelper.latLng(Context, String)</em> as follows:</p>
<pre><code>package org.wit.android.helpers;

import android.content.Context;
import android.widget.Toast;
import com.google.android.gms.maps.model.LatLng;
import java.lang.NumberFormatException;
import static org.wit.android.helpers.LogHelpers.info;

public class MapHelper
{
  public static LatLng latLng(Context context, String geolocation)
  {
    String[] g = geolocation.split(&quot;,&quot;);
    try
    {
      if (g.length == 2)
      {
        return new LatLng(Double.parseDouble(g[0]), Double.parseDouble(g[1]));
      }
    }
    catch (NumberFormatException e)
    {
      info(context, &quot;Number format exception: invalid geolocation: &quot; + e.getMessage());
    }
    Toast.makeText(context, &quot;An invalid geolocation has been entered: defaulting to 0,0&quot;, Toast.LENGTH_SHORT).show();
    return new LatLng(0, 0);

  }

  public static String latLng(LatLng geo)
  {

    return String.format(&quot;%.6f&quot;, geo.latitude) + &quot;, &quot; + String.format(&quot;%.6f&quot;, geo.longitude);
  }

}
</code></pre>

<p>Add these import statements:</p>
<pre><code>import java.lang.NumberFormatException;
import android.widget.Toast;
</code></pre>

<p>Test this validation as follows:</p>
<ul>
<li>Continue deleting digits from the default geolocation until the data is invalid as shown in Figure 1 above.</li>
<li>This will result in Toast messages being generated as shown in Figure 2.</li>
<li>Once you correct the input these messages are no longer generated and the map should automatically render correctly.</li>
</ul>
<p><img alt="Figure 2: Incorrectly entered geolocation triggers Toast warning" src="img/26.png"></p>
<p>The final task in this step is to immediately mirror the geolocation in the title as the input is changed (as shown in Figure 3).</p>
<ul>
<li>To do this, refactor the method *onMarkerDragEnd.</li>
</ul>
<p><img alt="Figure 3: Title mirrors geolocation input field" src="img/28.png"></p>
<p>Simply add the following line of code at the end of <em>onMarkerDragEnd</em>.</p>
<pre><code>geolocation.setText(residence.geolocation);
</code></pre>

<p>Run the app and test the features added above namely those that ensure that:</p>
<ul>
<li>A map is rendered</li>
<li>Inputting invalid data generates a Toast message</li>
<li>Inputting valid data following the toast message results in the map rendering correctly</li>
<li>The title immediately mirrors any changes in the geolocation input.</li>
<li>The EditText input box display changes dynamically as the marker is dragged.</li>
</ul>
	  </section>
	  <section data-tab="09" class="ui tab stacked moodle-book segment">
	     <h1>Scrollable (portrait)</h1>
<p>Make the data-input portion of the details view scrollable.</p>
<p>Official documentation on ScrollView is available <a href="http://developer.android.com/reference/android/widget/ScrollView.html">here</a>:</p>
<p><img alt="" src="img/20.png"></p>
<p>Here is the refactoted <em>fragment_residence.xml</em>:</p>
<pre><code>&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    android:layout_width=&quot;match_parent&quot;
    android:layout_height=&quot;match_parent&quot;
    android:orientation=&quot;vertical&quot; &gt;   
  &lt;LinearLayout
      android:layout_width=&quot;match_parent&quot;
      android:layout_height=&quot;0dp&quot;
      android:layout_weight=&quot;60&quot;
      android:baselineAligned=&quot;false&quot;
      android:orientation=&quot;vertical&quot; &gt; 
      &lt;ScrollView 
        android:layout_width=&quot;fill_parent&quot;
        android:layout_height=&quot;wrap_content&quot;&gt;  
        &lt;LinearLayout 
          android:id=&quot;@+id/container&quot;
          android:orientation=&quot;vertical&quot; 
          android:layout_width=&quot;fill_parent&quot;
          android:layout_height=&quot;wrap_content&quot;&gt;   
          &lt;!-- LOCATION --&gt;
          &lt;TextView
            android:layout_width=&quot;match_parent&quot;
            android:layout_height=&quot;wrap_content&quot;
            android:text=&quot;@string/location&quot;
            style=&quot;?android:listSeparatorTextViewStyle&quot;/&gt; 
            &lt;LinearLayout
              android:layout_width=&quot;match_parent&quot;
              android:layout_height=&quot;wrap_content&quot;
              android:orientation=&quot;horizontal&quot; 
              android:baselineAligned=&quot;false&quot; &gt;             
             &lt;!-- Geolocation (GPS Coords) --&gt;      
             &lt;LinearLayout
               android:layout_width=&quot;0dp&quot;
               android:layout_height=&quot;match_parent&quot;
               android:layout_weight=&quot;60&quot;
               android:orientation=&quot;vertical&quot; &gt;  
             &lt;TextView
               android:layout_width=&quot;wrap_content&quot;
               android:layout_height=&quot;wrap_content&quot;
               android:layout_marginLeft=&quot;10dp&quot;
               android:text=&quot;@string/geolocation&quot; /&gt;            
             &lt;EditText   
               android:id=&quot;@+id/geolocation&quot;
               android:layout_width=&quot;wrap_content&quot;
               android:layout_height=&quot;wrap_content&quot;
               android:hint=&quot;@string/geolocation_hint&quot; &gt;
               &lt;requestFocus /&gt;
             &lt;/EditText&gt; 
           &lt;/LinearLayout&gt; 
           &lt;!-- Show Map Button --&gt;          
           &lt;LinearLayout
             android:layout_width=&quot;0dp&quot;
             android:layout_height=&quot;match_parent&quot;
             android:layout_weight=&quot;40&quot;
             android:orientation=&quot;vertical&quot; &gt;                        
            &lt;Button
              android:id=&quot;@+id/show_map&quot;
              android:layout_width=&quot;wrap_content&quot;
              android:layout_height=&quot;wrap_content&quot;
              android:layout_marginLeft=&quot;16dp&quot;
              android:layout_marginRight=&quot;16dp&quot;
              android:layout_marginTop=&quot;16dp&quot;
              android:enabled=&quot;false&quot; /&gt;        
            &lt;/LinearLayout&gt;   
          &lt;/LinearLayout&gt;   
          &lt;!-- STATUS --&gt;   
          &lt;TextView
            android:layout_width=&quot;match_parent&quot;
            android:layout_height=&quot;wrap_content&quot;
            android:text=&quot;@string/status&quot;
            style=&quot;?android:listSeparatorTextViewStyle&quot;/&gt; 
          &lt;Button android:id=&quot;@+id/registration_date&quot;
            android:layout_width=&quot;match_parent&quot;
            android:layout_height=&quot;wrap_content&quot;
            android:layout_marginLeft=&quot;16dp&quot;
            android:layout_marginRight=&quot;16dp&quot; /&gt;
          &lt;CheckBox
            android:id=&quot;@+id/isrented&quot;
            android:layout_width=&quot;wrap_content&quot;
            android:layout_height=&quot;wrap_content&quot;
            android:enabled=&quot;true&quot;
            android:focusable=&quot;false&quot;
            android:gravity=&quot;center&quot;
            android:text=&quot;@string/rented_checkbox_text&quot;/&gt;
          &lt;Button
            android:id=&quot;@+id/tenant&quot;
            android:layout_width=&quot;match_parent&quot;
            android:layout_height=&quot;wrap_content&quot;
            android:layout_marginLeft=&quot;16dp&quot;
            android:layout_marginRight=&quot;16dp&quot;
            android:text=&quot;@string/landlord&quot; /&gt;    
          &lt;Button android:id=&quot;@+id/residence_reportButton&quot;
            android:layout_width=&quot;match_parent&quot;
            android:layout_height=&quot;wrap_content&quot;
            android:layout_marginLeft=&quot;16dp&quot;
            android:layout_marginRight=&quot;16dp&quot;
            android:text=&quot;@string/residence_report&quot;/&gt; 
        &lt;/LinearLayout&gt;
      &lt;/ScrollView&gt;
    &lt;/LinearLayout&gt;   
    &lt;LinearLayout
      android:layout_width=&quot;match_parent&quot;
      android:layout_height=&quot;0dp&quot;
      android:layout_weight=&quot;40&quot;
      android:baselineAligned=&quot;false&quot;
      android:orientation=&quot;vertical&quot; &gt;

      &lt;FrameLayout
          android:id=&quot;@+id/map&quot;
          android:layout_width=&quot;match_parent&quot;
          android:layout_height=&quot;wrap_content&quot;/&gt;
    &lt;/LinearLayout&gt;
&lt;/LinearLayout&gt;
</code></pre>

<p>Replace the existing code with above and test that the details view is now scrollable:</p>
<ul>
<li>Note that the map section is not scrollable.</li>
<li>Note also that the introduction of this change may result in the soft keyboard being automatically opened when the app is installed on a physical device. </li>
<li>To avoid this occurrence modify the ResidencePagerActivity in the Manifest file as follows:</li>
</ul>
<pre><code>    &lt;activity 
        android:name=&quot;.activities.ResidencePagerActivity&quot;
        android:label=&quot;@string/app_name&quot;
        android:windowSoftInputMode=&quot;stateHidden|adjustResize&quot; &gt;
</code></pre>

<p>Figure 1 should help you to understand the changes made here.</p>
<p><img alt="Figure 1: Refactored layout includes ScrollView" src="img/24.png"></p>
	  </section>
	  <section data-tab="10" class="ui tab stacked moodle-book segment">
	     <h1>Landscape</h1>
<p>We shall now add a landscape layout.</p>
<ul>
<li>Create a new folder: res/layout-land.</li>
<li>Add the following <em>fragment_residence.xml</em> file to this folder.</li>
<li>Build and install the app on a device and check that the details view renders satisfactorily in both portrait and landscape modes.</li>
<li>Study the landscape and portrait files and note small number of changes made to the portrait version to make it suitable for landscape.</li>
</ul>
<pre><code>&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    android:layout_width=&quot;match_parent&quot;
    android:layout_height=&quot;match_parent&quot;
    android:orientation=&quot;horizontal&quot; android:baselineAligned=&quot;false&quot;&gt;
  &lt;LinearLayout
    android:layout_width=&quot;0dp&quot;
    android:layout_height=&quot;match_parent&quot;
    android:layout_weight=&quot;60&quot;
    android:baselineAligned=&quot;false&quot;
    android:orientation=&quot;vertical&quot; &gt;
    &lt;ScrollView 
      android:layout_width=&quot;fill_parent&quot;
      android:layout_height=&quot;wrap_content&quot;&gt;  
      &lt;LinearLayout 
        android:id=&quot;@+id/container&quot;
        android:orientation=&quot;vertical&quot; 
        android:layout_width=&quot;fill_parent&quot;
        android:layout_height=&quot;wrap_content&quot;&gt;   
       &lt;!-- LOCATION --&gt;
       &lt;TextView
         android:layout_width=&quot;match_parent&quot;
         android:layout_height=&quot;wrap_content&quot;
         android:text=&quot;@string/location&quot;
         style=&quot;?android:listSeparatorTextViewStyle&quot;/&gt; 
        &lt;LinearLayout
          android:layout_width=&quot;match_parent&quot;
          android:layout_height=&quot;wrap_content&quot;
          android:orientation=&quot;horizontal&quot; 
          android:baselineAligned=&quot;false&quot;&gt;           
        &lt;!-- Geolocation (GPS Coords) --&gt;      
        &lt;LinearLayout
          android:layout_width=&quot;0dp&quot;
          android:layout_height=&quot;match_parent&quot;
          android:layout_weight=&quot;60&quot;
          android:orientation=&quot;vertical&quot; &gt;        
          &lt;TextView
            android:layout_width=&quot;wrap_content&quot;
            android:layout_height=&quot;wrap_content&quot;
            android:layout_marginLeft=&quot;10dp&quot;
            android:text=&quot;@string/geolocation&quot; /&gt;             
          &lt;EditText   
            android:id=&quot;@+id/geolocation&quot;
            android:layout_width=&quot;wrap_content&quot;
            android:layout_height=&quot;wrap_content&quot;
            android:hint=&quot;@string/geolocation_hint&quot; &gt;
           &lt;requestFocus /&gt;   
          &lt;/EditText&gt; 
        &lt;/LinearLayout&gt; 
        &lt;!-- Show Map Button --&gt;          
        &lt;LinearLayout
          android:layout_width=&quot;0dp&quot;
          android:layout_height=&quot;match_parent&quot;
          android:layout_weight=&quot;40&quot;
          android:orientation=&quot;vertical&quot; &gt;                     
          &lt;Button
            android:id=&quot;@+id/show_map&quot;
            android:layout_width=&quot;wrap_content&quot;
            android:layout_height=&quot;wrap_content&quot;
            android:layout_marginLeft=&quot;16dp&quot;
            android:layout_marginRight=&quot;16dp&quot;
            android:layout_marginTop=&quot;16dp&quot;
            android:enabled=&quot;false&quot; /&gt;      
        &lt;/LinearLayout&gt;
      &lt;/LinearLayout&gt;   
      &lt;!-- STATUS --&gt;   
      &lt;TextView
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:text=&quot;@string/status&quot;
        style=&quot;?android:listSeparatorTextViewStyle&quot;/&gt;     
        &lt;Button 
          android:id=&quot;@+id/registration_date&quot;
          android:layout_width=&quot;match_parent&quot;
          android:layout_height=&quot;wrap_content&quot;
          android:layout_marginLeft=&quot;16dp&quot;
          android:layout_marginRight=&quot;16dp&quot;/&gt;

       &lt;CheckBox
          android:id=&quot;@+id/isrented&quot;
          android:layout_width=&quot;wrap_content&quot;
          android:layout_height=&quot;wrap_content&quot;
          android:enabled=&quot;true&quot;
          android:focusable=&quot;false&quot;
          android:gravity=&quot;center&quot;
          android:text=&quot;@string/rented_checkbox_text&quot;/&gt;
        &lt;Button
          android:id=&quot;@+id/tenant&quot;
          android:layout_width=&quot;match_parent&quot;
          android:layout_height=&quot;wrap_content&quot;
          android:layout_marginLeft=&quot;16dp&quot;
          android:layout_marginRight=&quot;16dp&quot;
          android:text=&quot;@string/landlord&quot; /&gt;  

        &lt;Button android:id=&quot;@+id/residence_reportButton&quot;
          android:layout_width=&quot;match_parent&quot;
          android:layout_height=&quot;wrap_content&quot;
          android:layout_marginLeft=&quot;16dp&quot;
          android:layout_marginRight=&quot;16dp&quot;
          android:text=&quot;@string/residence_report&quot;/&gt; 
      &lt;/LinearLayout&gt;
    &lt;/ScrollView&gt;
  &lt;/LinearLayout&gt;   
  &lt;LinearLayout
    android:layout_width=&quot;0dp&quot;
    android:layout_height=&quot;match_parent&quot;
    android:layout_weight=&quot;40&quot;
    android:baselineAligned=&quot;false&quot;
    android:orientation=&quot;vertical&quot; &gt;

    &lt;FrameLayout
      android:id=&quot;@+id/map&quot;
      android:layout_width=&quot;match_parent&quot;
      android:layout_height=&quot;wrap_content&quot;/&gt;
  &lt;/LinearLayout&gt;
&lt;/LinearLayout&gt;
</code></pre>

<p>Test the scrollable feature in both portrait and landscape modes.</p>
<ul>
<li>It may be necessary to do so on a physical device (phone) as the scrollable feature is only evident when the screen size demands it.</li>
</ul>
	  </section>
	  <section data-tab="Archives" class="ui tab stacked moodle-book segment">
	     <h1>Archives</h1>
<p>This is a version of MyRent complete to the end if this lab:</p>
<ul>
<li><a href="archives/MyRentV08.zip">MyRentV08</a></li>
</ul>
	  </section>
<script>

function addCaptions() {
  var images = $(".moodle-book img");
  jQuery.each(images, function(i)  {
    if((images[i].alt).length > 0) 
    {
      var div_img = $(document.createElement("div")).addClass("ui segment");
      $(images[i]).wrap(div_img);
      var div_label = $(document.createElement("div")).addClass("ui ribbon teal top attached label");
      div_label.append(images[i].alt);
      $(div_label).insertBefore(images[i]);
    }
  });
};

// Need to check if we have already been loaded
seen = 0;

$(document).ready(function()
{ 
  if (seen == 0)
  { 
    // not loaded before - so do the restyling once (need to moodle book print)
    $(".moodle-book img").addClass ("ui image");
    $(".moodle-book pre").addClass ("ui segment");
    addCaptions();
    seen = 1;
  }


})</script>
  <br>  
  <div class="ui fixed bottom borderless menu">'
    <div class="ui small item"> 
    <p id="footertext">
    Prepared by  Eamonn de Leastar (edeleastar@tssg.wit.ie) & John Fitzgerald (johnjfitzgerald@outlook.com). Except where otherwise noted, this content is licensed under a  
     <a  href="http://creativecommons.org/licenses/by-nc/4.0/" title="External link to http://creativecommons.org/licenses/by-nc/4.0/" 
       target="_blank">Creative Commons Attribution-NonCommercial 4.0 License
     </a>
     </p>
    </div>
  </div>   
    
  <script>
    $(document).ready(function()
    {  
      $('.tab-menu.menu .item').tab();
    });
  </script>   
  </body>
 </html>