 <!DOCTYPE html>
 <html>
   <head>

     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">

     <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet" type="text/css">
     <link href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/solarized_light.min.css" rel="stylesheet" />

     <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
     <script type="text/javascript" src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
     <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/highlight.min.js"></script>
     <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/languages/java.min.js"></script>
     <script>hljs.initHighlightingOnLoad();</script>

      <style>


body 
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
}

figcaption
{
  margin-bottom: 20px;
}

.vertical-align
{
  display: flex;
  align-items: center;
}

.credits
{
  min-height:20px;
}
    </style>

  </head>

  <body>

    <div class="container">
<style>


code
{
  font-family: "Monaco";
  font-size: 110%;
}

img
{
  padding:1px;
  border:1px solid black;
}

h1
{
  font-style:italic;
  font-size:130%;
  border-bottom: thin solid black;
}
h2
{
  font-size:110%;
  border-bottom: thin solid black;
}
h3
{
  font-size:100%;
  border-bottom: thin solid black;
}

</style>

<div class="navbar navbar-default navbar-inverse navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <a type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></a>
      <div class="navbar-brand">
        <a onclick="window.history.back()" href="#"> <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span> </a>
        11: Assignment Studio
      </div>
    </div>
    <div class="collapse navbar-collapse navbar-ex1-collapse">
      <ul class="nav navbar-nav navbar-right">
        <li class="active"><a href= "#Donation-10" data-toggle="tab"> Donation-10 </a> </li>
          <li><a href= "#01" data-toggle="tab"> 01 </a> </li>
          <li><a href= "#02" data-toggle="tab"> 02 </a> </li>
          <li><a href= "#03" data-toggle="tab"> 03 </a> </li>
          <li><a href= "#04" data-toggle="tab"> 04 </a> </li>
          <li><a href= "#Exercises" data-toggle="tab"> Exercises </a> </li>
      </ul>
    </div>
  </div>
</div>

<br><br>

<div class="tab-content">
  <div class="tab-pane active" id="Donation-10">
    <h1>Objectives</h1>
<p>With the revised service implemented and deployed, upgrade donation-android to use this new API.</p>
  </div>

    <div class="tab-pane fade" id="01">
      <h1>App &amp; Welcome</h1>
<p>First some improvements in the way we are initializing the connection to the donation service.</p>
<p>In the DonationApp class, we need to keep track of the currently logged in user:</p>
<h1>App</h1>
<pre><code>  public User            currentUser;
</code></pre>

<p>Which we maintain in the validUser method:</p>
<pre><code>  public boolean validUser (String email, String password)
  {
    for (User user : users)
    {
      if (user.email.equals(email) &amp;&amp; user.password.equals(password))
      {
        currentUser = user;
        return true;
      }
    }
    return false;
  }
</code></pre>

<p>In the Welcome activity - whenever we resume the activity, we can set this user to null:</p>
<h1>Welcome</h1>
<pre><code>  @Override
  public void onResume()
  {
    super.onResume();
    app.currentUser = null;
    DonationServiceAPI.getUsers(this, this, &quot;Retrieving list of users&quot;);
  }
</code></pre>

<p>This means the app effectively logs out if it goes into the background.</p>
    </div>
    <div class="tab-pane fade" id="02">
      <h1>DonationServiceAPI</h1>
<p>In the models package, we will must introduce new methods for retrieving and creating donations:</p>
<pre><code>  public static void getDonations(Context context, User user, Response&lt;Donation&gt; response, String dialogMesssage)
  {
    new GetDonations(context, user, response, dialogMesssage).execute();
  }

  public static void createDonation(Context context, User user, Response&lt;Donation&gt; response, String dialogMesssage, Donation donation)
  {
    new CreateDonation(context, user, response, dialogMesssage).execute(donation);
  }
</code></pre>

<p>THese go into the DonatinsServiceAPI class.</p>
<p>They rely on the following classes, appended to the same java file:</p>
<pre><code>class GetDonations extends Request
{
  private User user;

  public GetDonations(Context context, User user, Response&lt;Donation&gt; callback, String message)
  {
    super(context, callback, message);
    this.user = user;
  }

  @Override
  protected List&lt;Donation&gt; doRequest(Object... params) throws Exception
  {
    String response =  Rest.get(&quot;/api/users/&quot; + user.id + &quot;/donations&quot;);
    List&lt;Donation&gt; donationList = JsonParsers.json2Donations(response);
    return donationList;
  }
}
</code></pre>

<pre><code>class CreateDonation extends Request
{
  private User user;

  public CreateDonation(Context context, User user, Response&lt;Donation&gt; callback, String message)
  {
    super(context, callback, message);
    this.user = user;
  }

  @Override
  protected Donation doRequest(Object... params) throws Exception
  {
    String response = Rest.post (&quot;/api/users/&quot; + user.id + &quot;/donations&quot;, JsonParsers.donation2Json(params[0]));
    return JsonParsers.json2Donation(response);
  }
}
</code></pre>
    </div>
    <div class="tab-pane fade" id="03">
      <h1>Donate</h1>
<p>We can now rework this method on the Donate activity:</p>
<pre><code>  public void donateButtonPressed (View view) 
  {
    String method = paymentMethod.getCheckedRadioButtonId() == R.id.PayPal ? &quot;PayPal&quot; : &quot;Direct&quot;;
    int donatedAmount =  amountPicker.getValue();
    if (donatedAmount == 0)
    {
      String text = amountText.getText().toString();
      if (!text.equals(&quot;&quot;))
        donatedAmount = Integer.parseInt(text);
    }
    if (donatedAmount &gt; 0)
    {
      DonationServiceAPI.createDonation(this, app.currentUser, this, &quot;Registering new donation...&quot;, new Donation(donatedAmount, method));
    }
   }
</code></pre>

<p>There is only one small change - the call to createDonation will require the currently logged in user.</p>
    </div>
    <div class="tab-pane fade" id="04">
      <h1>Report</h1>
<p>Similarly for the Report Activity:</p>
<pre><code>  @Override
  public void onCreate(Bundle savedInstanceState)
  {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_report);

    app = (DonationApp) getApplication();

    listView = (ListView) findViewById(R.id.reportList);
    adapter = new DonationAdapter (this, app.donations);

    listView.setAdapter(adapter);

    DonationServiceAPI.getDonations(this, app.currentUser, this, &quot;Downloading Donations List..&quot;);
  }
</code></pre>

<p>Getting donations will require the current user as well.</p>
<p>This should all compile and run now. Make sure the play service is running.</p>
    </div>
    <div class="tab-pane fade" id="Exercises">
      <h1>Exercises</h1>
<p>This is an archive of the two projects so far:</p>
<ul>
<li><a href="./archives/donation-android-v6.zip">donation-android-v6</a></li>
</ul>
<h2>Exercise 1</h2>
<p>Deploy the play project to heroku. Verify that the android app works against the deployed version.</p>
<h2>Exercise 2</h2>
<p>If you had a go at the exercises from the last, you might have developed an API for one or more of the following:</p>
<ul>
<li>List all donations, regardless of user id</li>
<li>Delete all donations for a specific user</li>
<li>Delete all donations for all users</li>
</ul>
    </div>
</div>
<br> <br>


    </div>


<div class="credits navbar navbar-default navbar-fixed-bottom" role="navigation">
  <small>
    Prepared by Eamonn de Leastar (edeleastar@tssg.wit.ie) & John Fitzgerald (johnjfitzgerald@outlook.com). Except where otherwise noted, this content is licensed under a
    <a href="http://creativecommons.org/licenses/by-nc/4.0/" title="External link to http://creativecommons.org/licenses/by-nc/4.0/"
        target="_blank">Creative Commons Attribution-NonCommercial 4.0 License
    </a>
    </small>
</div>    <script>

$(document).ready(function()
{
  $("img").addClass ("img-responsive");

  $(".tab-content img").each(function()
  {
    var title = this.alt;
    $(this).after('<figcaption class="caption"> <em>'+ title +'</em></figcaption>');
  });
})    </script>

  </body>
 </html>